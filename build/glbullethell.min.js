phina.namespace(function(){phina.define("glb.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t,e){var i=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,i[a+0]=this.x,i[a+1]=this.y,i[a+2]=t.direction,i[a+3]=1.5,i[a+4]=e.type%8,i[a+5]=~~(e.type/8),i[a+6]=1,i[a+7]=1,i[a+8]=.2+~~(e.type/8)%2,i[a+9]=.2,i[a+10]=.2+~~(e.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var e=this.instanceData,i=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-100||SCREEN_WIDTH+100<this.x||this.y<-100||SCREEN_HEIGHT+100<this.y?void this.remove():(e[i+0]=this.x,e[i+1]=this.y,e[i+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))}})}),phina.namespace(function(){phina.define("glb.BulletSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:1e3,init:function(t,e,i,a){this.superInit(t,e),this.setProgram(phigl.Program(t).attach("bulletSprites.vs").attach("bulletSprites.fs").link()).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[i/2,.75*a,1.5*i],[i/2,a/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-i/2,i/2,a/2,-a/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,"bullets.png")),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(n);var o=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Bullet(t,n,s).on("removed",function(){o.pool.push(this)})})},get:function(){var t=this.pool.shift();return t},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.Effect",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,rotation:0,scale:0,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){var e=this.index,i=this.instanceData;return this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scale=t.scale,this.alpha=t.alpha,i[e+0]=1,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scale,i[e+5]=0,i[e+6]=0,i[e+7]=this.alpha,this.age=0,this},update:function(t){var e=this.index,i=this.instanceData;(this.x<-100||740<this.x||this.y<-100||1060<this.y)&&this.remove(),i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scale,i[e+7]=this.alpha,this.age+=1}})}),phina.namespace(function(){phina.define("glb.EffectSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:200,init:function(t,e,i,a){this.superInit(t,e),this.setProgram(phigl.Program(t).attach("effectSprites.vs").attach("effectSprites.fs").link()).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceAlpha").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[i/2,.75*a,1.5*i],[i/2,a/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-i/2,i/2,a/2,-a/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,this._createTexture())),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,0,1,0,0,0);this.setInstanceAttributeData(n);var o=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Effect(t,n,s).on("removed",function(){n[this.index+0]=0,o.pool.push(this)})})},_createTexture:function(){var t=phina.graphics.Canvas().setSize(512,512),e=t.context,i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255, 255, 255, 0.3)"),i.addColorStop(.6,"rgba(255, 125,   0, 0.3)"),i.addColorStop(1,"rgba(255,   0,   0, 0.0)"),e.fillStyle=i,e.fillRect(0,0,64,64),t},get:function(){return this.pool.shift()},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.EnemiesDrawer",{gl:null,faceDrawer:null,instanceData:null,pool:null,count:0,cameraPosition:null,enemyTypes:[],init:function(t,e,i,a,s,n){this.gl=i,this.count=t,this.faceDrawer=phigl.InstancedDrawable(i,a);for(var r=this.instanceData=[],o=0;o<this.count;o++)r.push(0,0,0,0,0,0,0,1,1,1);var h=phina.asset.AssetManager.get("obj",e);this.faceDrawer.setProgram(phigl.Program(i).attach("obj.vs").attach("obj.fs").link()).setIndexValues(h.getIndices()).setAttributes("position","uv","normal").setAttributeData(h.getAttributeData()).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition");var c=this.faceDrawer.instanceStride/4;this.cameraPosition=vec3.create(),vec3.set(this.cameraPosition,s/2,.75*n,1.5*s);var l=mat4.lookAt(mat4.create(),this.cameraPosition,[s/2,n/2,0],[0,1,0]),u=mat4.ortho(mat4.create(),-s/2,s/2,n/2,-n/2,.1,3e3);this.faceDrawer.uniforms.vpMatrix.value=mat4.mul(mat4.create(),u,l),this.faceDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.lightDirection=vec3.set(vec3.create(),1,-1,-1),this.faceDrawer.uniforms.lightDirection.value=vec3.normalize(vec3.create(),this.lightDirection),this.faceDrawer.uniforms.diffuseColor.value=[.4,.4,.4,1],this.faceDrawer.uniforms.ambientColor.value=[.4,.4,.4,1];var f=this;this.pool=Array.range(0,this.count).map(function(t){return glb.Obj(t,r,c).on("removed",function(){r[this.index+0]=0,f.pool.push(this)})}),this.faceDrawer.setInstanceAttributeData(this.instanceData)},update:function(t){.01*t.ticker.frame;this.faceDrawer.setInstanceAttributeData(this.instanceData)},get:function(){return this.pool.shift()},render:function(){var t=this.gl;t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.faceDrawer.draw(this.count)}})}),phina.namespace(function(){phina.define("glb.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,domElement:null,gl:null,terrain:null,effectSprites:null,bulletSprites:null,init:function(){this.superInit({width:720,height:1280}),this.originX=0,this.originY=0,this.domElement=document.createElement("canvas"),this.domElement.width=this.width*glb.GLLayer.quality,this.domElement.height=this.height*glb.GLLayer.quality,this.gl=this.domElement.getContext("webgl");var t=phigl.Extensions.getInstancedArrays(this.gl),e=(phigl.Extensions.getVertexArrayObject(this.gl),this.gl);e.clearColor(0,0,0,0),this.terrain=glb.Terrain(e,t,this.width,this.height),this.effectSprites=glb.EffectSprites(e,t,this.width,this.height),this.bulletSprites=glb.BulletSprites(e,t,this.width,this.height),this.enemies=glb.EnemiesDrawer(1,"enemyS1.obj",e,t,this.width,this.height);var i=this,a=glb.Terrain.countX,s=glb.Terrain.countZ,n=glb.Terrain.unit;Array.range(-a,a).forEach(function(t){Array.range(-s,s).forEach(function(e){var a=i.getHex();a&&a.spawn({x:t*n+e%2,y:Math.random()<.04?5:0,z:e*n*1/Math.sqrt(3)*1.5,rotX:0,rotY:0,rotZ:0,scaleX:1.1,scaleY:1.1,scaleZ:1.1}).addChildTo(i)})})},getHex:function(){return this.terrain.get()},getEffect:function(){return this.effectSprites.get()},getBullet:function(){return this.bulletSprites.get()},update:function(t){this.terrain.update(t),this.effectSprites.update(t),this.bulletSprites.update(t),this.enemies.update(t)},draw:function(t){var e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.terrain.render(),this.enemies.render(),this.effectSprites.render(),this.bulletSprites.render(),e.flush();var i=this.domElement;t.context.drawImage(i,0,0,i.width,i.height,-this.width*this.originX,-this.height*this.originY,this.width,this.height)},_static:{quality:.5}})}),phina.namespace(function(){phina.define("glb.Obj",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,z:0,rotX:0,rotY:0,rotZ:0,scaleX:0,scaleY:0,scaleZ:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){var e=this.index,i=this.instanceData;return this.age=0,this.x=t.x,this.y=t.y,this.z=t.z,this.rotX=t.rotX,this.rotY=t.rotY,this.rotZ=t.rotZ,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.scaleZ=t.scaleZ,i[e+0]=1,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.z,i[e+4]=this.rotX,i[e+5]=this.rotY,i[e+6]=this.rotZ,i[e+7]=this.scaleX,i[e+8]=this.scaleY,i[e+9]=this.scaleZ,this},update:function(t){var e=this.index,i=this.instanceData;i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.z,i[e+4]=this.rotX,i[e+5]=this.rotY,i[e+6]=this.rotZ,i[e+7]=this.scaleX,i[e+8]=this.scaleY,i[e+9]=this.scaleZ,this.age+=1}})}),phina.namespace(function(){phina.define("glb.ObjAsset",{superClass:"phina.asset.File",init:function(){this.superInit()},getIndices:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e],a=0;return i.faces.forEach(function(t){for(var e=1;e<t.length-1;e++)a+=3}),Array.range(a)},getAttributeData:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e],a=[];return i.faces.forEach(function(t){for(var e=1;e<t.length-1;e++)a.push(t[0]),a.push(t[e+0]),a.push(t[e+1])}),a.map(function(t,e){var a=i.positions[t.position-1],s=i.texCoords[t.texCoord-1],n=i.normals[t.normal-1];return[a.x,a.y,a.z,s.u,s.v,n.x,n.y,n.z]}).flatten()},getAttributeDataEdges:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e];return i.faces.map(function(t){for(var e=[],i=0;i<t.length-1;i++)e.push([t[i+0].position,t[i+1].position]);return e.push([t.last.position,t.first.position]),e}).flatten(1).uniq(function(t,e){return t[0]===e[0]&&t[1]===e[1]}).map(function(t){var e=i.positions[t[0]-1],a=i.positions[t[1]-1];return[[e.x,e.y,e.z],[a.x,a.y,a.z]]}).flatten()}}),phina.asset.AssetLoader.assetLoadFunctions.obj=function(t,e){var i=glb.ObjAsset();return i.load({path:e})}}),phina.namespace(function(){phina.define("glb.Terrain",{gl:null,faceDrawer:null,edgeDrawer:null,instanceData:null,pool:null,count:0,cameraPosition:null,init:function(t,e,i,a){this.gl=t,this.count=2*glb.Terrain.countX*(2*glb.Terrain.countZ),this.faceDrawer=phigl.InstancedDrawable(t,e),this.edgeDrawer=phigl.InstancedDrawable(t,e);for(var s=this.instanceData=[],n=0;n<this.count;n++)s.push(0,0,0,0,0,0,0,1,1,1);var r=phina.asset.AssetManager.get("obj","hex.obj");this.faceDrawer.setProgram(phigl.Program(t).attach("terrain.vs").attach("terrain.fs").link()).setIndexValues(r.getIndices()).setAttributes("position","uv","normal").setAttributeData(r.getAttributeData()).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition"),this.edgeDrawer.setDrawMode(t.LINES).setProgram(phigl.Program(t).attach("terrainEdge.vs").attach("terrainEdge.fs").link()).setIndexValues(r.getIndices()).setAttributes("position").setAttributeData(r.getAttributeDataEdges()).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale").setUniforms("vpMatrix","cameraPosition","color");var o=this.edgeDrawer.instanceStride/4;this.cameraPosition=vec3.create(),vec3.set(this.cameraPosition,6,20,20);var h=mat4.lookAt(mat4.create(),this.cameraPosition,[0,0,0],[0,1,0]),c=mat4.perspective(mat4.create(),45,i/a,.1,1e4);this.faceDrawer.uniforms.vpMatrix.value=mat4.mul(mat4.create(),c,h),this.faceDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.edgeDrawer.uniforms.vpMatrix.value=mat4.mul(mat4.create(),c,h),this.edgeDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.lightDirection=vec3.set(vec3.create(),1,-1,-1),this.faceDrawer.uniforms.lightDirection.value=vec3.normalize(vec3.create(),this.lightDirection),this.faceDrawer.uniforms.diffuseColor.value=[.22,.22,.44,.7],this.faceDrawer.uniforms.ambientColor.value=[.1,.1,.1,1],this.edgeDrawer.uniforms.color.value=[1,1,1,1];var l=this;this.pool=Array.range(0,this.count).map(function(t){return glb.Obj(t,s,o).on("enterframe",function(){this.x+=.015*l.cameraPosition[0],this.z+=.015*l.cameraPosition[2];var t=glb.Terrain.countX,e=glb.Terrain.countZ,i=glb.Terrain.unit;this.x<-t*i?this.x+=t*i*2:t*i<this.x&&(this.x-=t*i*2),this.z<-e*i*1/Math.sqrt(3)*1.5?this.z+=e*i*1/Math.sqrt(3)*1.5*2:e*i*1/Math.sqrt(3)*1.5<this.z&&(this.z-=e*i*1/Math.sqrt(3)*1.5*2)}).on("removed",function(){s[this.index+0]=0,l.pool.push(this)})}),this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData)},update:function(t){var e=.001*t.ticker.frame;this.lightDirection=vec3.set(this.lightDirection,2*Math.cos(10*e),1,2*Math.sin(10*e)),vec3.normalize(this.lightDirection,this.lightDirection),this.faceDrawer.uniforms.lightDirection.value=this.lightDirection,this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData)},get:function(){return this.pool.shift()},render:function(){var t=this.gl;t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.edgeDrawer.draw(this.count),this.faceDrawer.draw(this.count)},_static:{countX:12,countZ:22,unit:2.05}})}),phina.namespace(function(){Array.prototype.$method("uniq",function(t){return t?this.filter(function(e,i,a){return!a.slice(0,i).some(function(i){return t(e,i)})}):this.filter(function(t,e,i){return i.indexOf(t)===e})})});