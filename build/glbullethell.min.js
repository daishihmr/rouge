var SCREEN_WIDTH=720,SCREEN_HEIGHT=1080,OBJ_SCALE=30;phina.namespace(function(){phina.input.Keyboard.KEY_CODE.SHOT=phina.input.Keyboard.KEY_CODE.z,phina.input.Keyboard.KEY_CODE.BOMB=phina.input.Keyboard.KEY_CODE.x,phina.input.Keyboard.KEY_CODE.LASER=phina.input.Keyboard.KEY_CODE.c,phina.input.Gamepad.BUTTON_CODE.SHOT=phina.input.Gamepad.BUTTON_CODE.R2,phina.input.Gamepad.BUTTON_CODE.BOMB=phina.input.Gamepad.BUTTON_CODE.a,phina.input.Gamepad.BUTTON_CODE.LASER=phina.input.Gamepad.BUTTON_CODE.x;var t=document.createElement("canvas"),e=null;try{e=t.getContext("webgl")}catch(i){e=null,glb.ErrorScene.message="WebGL not supported"}phina.main(function(){phina.display.Label.defaults.fontFamily="Aldrich",phina.asset.AssetLoader().on("load",function(){a()}).load({font:{Aldrich:"./asset/font/Aldrich/Aldrich-Regular.ttf"}})});var a=function(){var i=phina.display.CanvasApp({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"black",fps:30}).replaceScene(e?glb.SceneFlow({canvas:t,gl:e}):glb.ErrorScene()).enableStats().run();i.gamepadManager=phina.input.GamepadManager(),i.update=function(){this.gamepadManager.update()}}}),phina.namespace(function(){phina.define("strike.NumberSpriteArray",{superClass:"phina.display.DisplayElement",sprites:null,commas:null,digit:0,_value:0,init:function(t){t={}.$extend({digit:8},t),this.digit=t.digit,this.sprites=Array.range(0,t.digit).map(function(){return strike.NumberSprite(t).setOrigin(0,0)}),this.superInit({width:this.sprites[0].width*t.digit,height:t.fontSize});var e=this;this.sprites.forEach(function(t,i,a){t.x+=(a.length-i-1)*t.width,t.addChildTo(e)}),this.commas=[];for(var i=1;i<this.digit/3;i++){var a=phina.display.Label({text:","}.$extend(t)).setPosition((this.digit-3*i)*this.sprites[0].width,.5*this.sprites[0].height).addChildTo(this);this.commas.push(a)}},setValue:function(t){this._value=t;var e=Math.floor(t),i=(""+e).length/3-1;this.commas.forEach(function(t,e){t.visible=i>e});for(var a=0;a<this.digit;a++)0===e?this.sprites[a].visible=!1:(this.sprites[a].visible=!0,this.sprites[a].frameIndex=e%10),e=Math.floor(e/10)},_accessor:{value:{get:function(){return this._value},set:function(t){this.setValue(t)}}}}),phina.define("strike.NumberSprite",{superClass:"phina.display.Sprite",init:function(t){t={}.$extend({fontSize:20,fontFamily:"sans-serif",fill:"white",stroke:null,fontWeight:""},t);var e=phina.graphics.Canvas(),i=e.context;this.unitWidth=Array.range(0,10).map(function(e){return i.font="{fontWeight} {fontSize}px '{fontFamily}'".format(t),i.measureText(""+e).width}).sort(function(t,e){return t-e}).map(function(t){return t}).last+1|0,this.unitWidth*=1.15;var a=10*this.unitWidth,s=t.fontSize;e.setSize(Math.pow(2,Math.log2(a)+1|0),Math.pow(2,Math.log2(s)+1|0)),i.font="{fontWeight} {fontSize}px '{fontFamily}'".format(t),i.fillStyle=t.fill,i.strokeStyle=t.stroke,i.textAlign="center",i.textBaseline="middle";for(var n=0;10>n;n++)t.fill&&i.fillText(""+n,this.unitWidth*(.5+n),s/2),t.stroke&&i.strokeText(""+n,a*(.5+n),s/2);this.superInit(e,this.unitWidth,s),this.setFrameIndex(0)}})}),phina.namespace(function(){phina.define("glb.ScorePanel",{superClass:"phina.display.DisplayElement",init:function(){this.superInit(),this.fromJSON({originX:0,originY:0,children:{}})}})}),phina.namespace(function(){phina.define("glb.UILayer",{superClass:"phina.display.DisplayElement",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.fromJSON({originX:0,originY:0,children:{scorePanel:{className:"glb.ScorePanel"}}})}})}),phina.namespace(function(){phina.define("glb.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,power:0,_active:!1,radius:20,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t,e){var i=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,i[a+0]=this.x,i[a+1]=this.y,i[a+2]=t.direction,i[a+3]=1.8,i[a+4]=e.type%8,i[a+5]=~~(e.type/8),i[a+6]=1,i[a+7]=1,i[a+8]=.2+~~(e.type/8)%2,i[a+9]=.2,i[a+10]=.2+~~(e.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var e=this.instanceData,i=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-100||SCREEN_WIDTH+100<this.x||this.y<-100||SCREEN_HEIGHT+100<this.y?void this.remove():(e[i+0]=this.x,e[i+1]=this.y,e[i+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))},hitPlayer:function(t){this.remove()}})}),phina.namespace(function(){phina.define("glb.BulletDrawer",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:2e3,init:function(t,e,i,a){this.superInit(t,e),this.setProgram(phina.asset.AssetManager.get("shader","bullets")).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vpMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.texture.setValue(0).setTexture(phina.asset.AssetManager.get("texture","bullets.png")),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(n);var o=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Bullet(t,n,s).on("removed",function(){o.pool.add(this)})}).toPool(function(t,e){return t.id-e.id})},get:function(){return this.pool.get()},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(t){var e=this.gl;e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.disable(e.DEPTH_TEST),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this)),this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.Camera",{position:null,vMatrix:null,pMatrix:null,vpMatrix:null,init:function(){this.position=vec3.create(),this.vMatrix=mat4.create(),this.pMatrix=mat4.create(),this.vpMatrix=mat4.create()},setPosition:function(t,e,i){return vec3.set(this.position,t,e,i),this},lookAt:function(t,e,i){return mat4.lookAt(this.vMatrix,this.position,[t,e,i],[0,1,0]),this},ortho:function(t,e,i,a,s,n){return mat4.ortho(this.pMatrix,t,e,i,a,s,n),this},perspective:function(t,e,i,a){return mat4.perspective(this.pMatrix,t,e,i,a),this},calcVpMatrix:function(){return mat4.mul(this.vpMatrix,this.pMatrix,this.vMatrix),this},uniformValues:function(){return{vpMatrix:this.vpMatrix,cameraPosition:this.position}}})}),phina.namespace(function(){phina.define("glb.Collisions",{superClass:"phina.util.EventDispatcher",player:null,bullets:null,enemies:null,shots:null,init:function(){this.superInit(),this.player=null,this.bullets=[],this.enemies=[],this.shots=[]},setPlayer:function(t){this.player=t,t.on("inactivated",function(){this.player=null}.bind(this)),t.on("removed",function(){this.player=null}.bind(this))},addBullet:function(t){this.bullets.push(t),t.on("inactivated",function(){this.bullets.erase(t)}.bind(this)),t.on("removed",function(){this.bullets.erase(t)}.bind(this))},addEnemy:function(t){this.enemies.push(t),t.on("inactivated",function(){this.enemies.erase(t)}.bind(this)),t.on("removed",function(){this.enemies.erase(t)}.bind(this))},addShot:function(t){this.shots.push(t),t.on("inactivated",function(){this.shots.erase(t)}.bind(this)),t.on("removed",function(){this.shots.erase(t)}.bind(this))},update:function(t){this._hitTestShotEnemy(),this._hitTestPlayerBullet(),this._hitTestPlayerEnemy()},_hitTestShotEnemy:function(){for(var t,e,i=this.shots.clone(),a=this.enemies.clone(),s=0,n=a.length;n>s;s++)if(e=a[s],!(e.muteki||!e.visible||e.mutekiTime>0||e.hp<=0))for(var r=0,o=i.length;o>r;r++)t=i[r],this._hitTestLineCircle(t,e)&&(e.hitShot(t),t.hitEnemy(e))},_hitTestPlayerBullet:function(){var t=this.player,e=this.bullets.clone();if(!(t.muteki||!t.visible||t.mutekiTime>0||t.hp<=0))for(var i,a=0,s=e.length;s>a;a++)i=e[a],(t.x-i.x)*(t.x-i.x)+(t.y-i.y)*(t.y-i.y)<i.radius*i.radius&&(t.hitBullet(i),i.hitPlayer(t))},_hitTestPlayerEnemy:function(){var t=this.player,e=this.enemies.clone();if(!(t.muteki||!t.visible||t.mutekiTime>0||t.hp>0))for(var i,a=0,s=e.length;s>a;a++)i=e[a],(t.x-i.x)*(t.x-i.x)+(t.y-i.y)*(t.y-i.y)<i.radius*i.radius&&(t.hitEnemy(i),i.hitPlayer(t))},_hitTestLineCircle:function(s,n){vec2.sub(t,[n.x,n.y],[s.bx,s.by]),vec2.sub(e,[n.x,n.y],[s.x,s.y]),vec2.sub(i,[s.x,s.y],[s.bx,s.by]);var r=n.radius,o=r*r;return vec2.squaredLength(t)<=o||vec2.squaredLength(e)<=o?!0:(vec2.cross(a,i,t),vec3.length(a)/vec2.length(i)<=r&&vec2.dot(t,i)*vec2.dot(e,i)<=0)}});var t=vec2.create(),e=vec2.create(),i=vec2.create(),a=vec3.create()}),phina.namespace(function(){phina.define("glb.EnemySpawner",{superClass:"phina.app.Element",init:function(t){this.superInit(),this.name=t.name,this.pattern=t.pattern,this.runner=t.runner,this.x=t.x,this.y=t.y}})}),phina.namespace(function(){phina.define("glb.Explosion",{glLayer:null,init:function(t){this.glLayer=t},spark:function(t,e){var i=this.glLayer;1..times(function(){var a=i.spriteDrawer.get("effect");if(a){var s=Math.randfloat(0,2*Math.PI),n=Math.randfloat(75,125),r=Math.randfloat(.1,.2);a.spawn({x:t+Math.cos(s)*n*.1,y:e+Math.sin(s)*n*.1,rotation:0,scaleX:r,scaleY:r,alpha:5}).addChildTo(i),a.tweener.clear().to({x:t+Math.cos(s)*n,y:e+Math.sin(s)*n,alpha:0},666,"easeOutQuart").call(function(){a.remove()})}})},small:function(t,e){var i=this.glLayer;7..times(function(){var a=i.spriteDrawer.get("effect");if(a){var s=Math.randfloat(0,2*Math.PI),n=Math.randfloat(30,45);a.spawn({x:t+Math.cos(s)*n*.2,y:e+Math.sin(s)*n*.2,rotation:0,scaleX:1,scaleY:1,alpha:1,frameX:0,frameY:0}).addChildTo(i),a.tweener.clear().to({x:t+Math.cos(s)*n,y:e+Math.sin(s)*n,scaleX:3,scaleY:3,alpha:0},333,"easeOutQuad").call(function(){a.remove()})}}),2..times(function(){var a=i.spriteDrawer.get("effect");if(a){var s=Math.randfloat(0,2*Math.PI),n=Math.randfloat(75,125),r=Math.randfloat(.2,.4);a.spawn({x:t+Math.cos(s)*n*.1,y:e+Math.sin(s)*n*.1,rotation:0,scaleX:r,scaleY:r,alpha:5,frameX:0,frameY:0}).addChildTo(i),a.tweener.clear().to({x:t+Math.cos(s)*n,y:e+Math.sin(s)*n,alpha:0},666,"easeOutQuad").call(function(){a.remove()})}})}})}),phina.namespace(function(){phina.define("glb.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,ready:!1,domElement:null,gl:null,orthoCamera:null,perseCamera:null,terrain:null,itemDrawer:null,spriteDrawer:null,bulletDrawer:null,playerDrawer:null,enemyDrawer:null,framebufferMain:null,framebufferZoom:null,ppZoom:null,ppCopy:null,zoomCenterX:0,zoomCenterY:0,zoomStrength:0,zoomAlpha:0,init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.originX=0,this.originY=0,this.domElement=t.canvas,this.domElement.width=this.width*glb.GLLayer.quality,this.domElement.height=this.height*glb.GLLayer.quality;var e=this.gl=t.gl,i=phigl.Extensions.getInstancedArrays(e);phigl.Extensions.getVertexArrayObject(e);e.viewport(0,0,this.domElement.width,this.domElement.height),e.clearColor(0,0,0,1),e.clearDepth(1),e.disable(e.CULL_FACE);var a=this.domElement.width,s=this.domElement.height,n=this.width,r=this.height,o=Math.pow(2,~~Math.log2(a)+1),h=Math.pow(2,~~Math.log2(s)+1);glb.GLLayer.quality;this.orthoCamera=glb.Camera().setPosition(.5*n,.5*r,1.5*n).lookAt(.5*n,.5*r,0).ortho(.5*-n,.5*n,.5*r,.5*-r,.1,3e3).calcVpMatrix(),this.perseCamera=glb.Camera().setPosition(6,20,20).lookAt(0,0,0).perspective(45,n/r,.1,1e4).calcVpMatrix(),this.terrain=glb.TerrainDrawer(e,i,n,r),this.itemDrawer=glb.ObjDrawer(e,i,n,r),this.spriteDrawer=glb.SpritDrawer(e,i,n,r),this.enemyDrawer=glb.ObjDrawer(e,i,n,r),this.playerDrawer=glb.ObjDrawer(e,i,n,r),this.bulletDrawer=glb.BulletDrawer(e,i,n,r),this.framebufferGlow=phigl.Framebuffer(e,o,h),this.framebufferZanzo1=phigl.Framebuffer(e,o,h),this.framebufferZanzo2=phigl.Framebuffer(e,o,h),this.framebufferMain=phigl.Framebuffer(e,o,h),this.framebufferZoom=phigl.Framebuffer(e,o,h),this.ppZoom=glb.PostProcessing(e,a,s,"postproccess_zoom",["canvasSize","center","strength"]),this.ppCopy=glb.PostProcessing(e,a,s,"postproccess_copy",["alpha"]),this.ppBlur=glb.PostProcessing(e,a,s,"postproccess_blur"),this.setupTerrain(),this.generateObjects(),this.ready=!0},setupTerrain:function(){var t=this,e=glb.TerrainDrawer.countX,i=glb.TerrainDrawer.countZ,a=glb.TerrainDrawer.unit;Array.range(-e,e).forEach(function(e){Array.range(-i,i).forEach(function(i){var s=t.terrain.get();s&&(s.spawn({visible:!0,x:e*a+i%2,y:0,z:i*a*1/Math.sqrt(3)*1.5,rotX:(-90).toRadian(),rotY:90..toRadian(),rotZ:0,scaleX:1.2,scaleY:1.2,scaleZ:1.2}).addChildTo(t),Math.random()<.03&&s.on("enterframe",function(t){this.y=2.5*(1+Math.sin(.01*t.app.ticker.frame))}))})})},generateObjects:function(){this.playerDrawer.addObjType("fighter","fighter",1,"glb.Player"),this.playerDrawer.addObjType("bit","bit",4),this.playerDrawer.addObjType("bitJoin","bitJoin",1),this.playerDrawer.addObjType("barrier","barrier",1),this.spriteDrawer.addObjType("shot","effect",160,"glb.Shot"),this.spriteDrawer.addObjType("laser","effect",20,"glb.Laser"),this.spriteDrawer.addObjType("effect","effect",3e3)},update:function(t){this.ready&&(this.terrain.update(t),this.itemDrawer.update(t),this.spriteDrawer.update(t),this.enemyDrawer.update(t),this.playerDrawer.update(t),this.bulletDrawer.update(t))},draw:function(t){if(this.ready){var e=this.gl,i=this.domElement,a=i.width,s=i.height,n=this.orthoCamera.uniformValues(),r=this.perseCamera.uniformValues();this.framebufferGlow.bind(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.enemyDrawer.renderGlow(n),this.playerDrawer.renderGlow(n),this.framebufferZanzo1.bind(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.ppCopy.render(this.framebufferZanzo2.texture,{alpha:.85},!0),this.ppBlur.render(this.framebufferGlow.texture,null,!0),this.framebufferMain.bind(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.terrain.render({diffuseColor:[.2,.2,.2*1.6,.7]}.$extend(r)),this.itemDrawer.render(n),this.enemyDrawer.render({diffuseColor:[1,1,1,1]}.$extend(n)),this.spriteDrawer.render(n),this.playerDrawer.render(n),this.ppCopy.render(this.framebufferZanzo1.texture,null,!0),this.bulletDrawer.render(n),this.zoomStrength>0&&this.zoomAlpha>0&&(this.framebufferZoom.bind(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.ppZoom.render(this.framebufferMain.texture,{center:this.ppZoom.viewCoordToShaderCoord(this.zoomCenterX,this.zoomCenterY),strength:this.zoomStrength})),phigl.Framebuffer.unbind(e),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.ppCopy.render(this.framebufferMain.texture,{alpha:1-this.zoomAlpha}),this.zoomStrength>0&&this.zoomAlpha>0&&this.ppCopy.render(this.framebufferZoom.texture,{alpha:this.zoomAlpha},!0),e.flush(),t.context.drawImage(i,0,0,a,s,-this.width*this.originX,-this.height*this.originY,this.width,this.height);var o=this.framebufferZanzo1;this.framebufferZanzo1=this.framebufferZanzo2,this.framebufferZanzo2=o}},startZoom:function(t,e){this.zoomCenterX=t,this.zoomCenterY=e,this.tweener.clear().set({zoomStrength:0,zoomAlpha:1}).to({zoomStrength:10,zoomAlpha:0},666,"easeOutQuad")},_static:{quality:1}})}),phina.namespace(function(){phina.define("glb.GlowEffect",{gl:null,current:null,before:null,drawer:null,width:0,height:0,init:function(t,e,i){this.gl=t;var a=Math.pow(2,~~Math.log2(e)+1),s=Math.pow(2,~~Math.log2(i)+1);this.current=phigl.Framebuffer(t,a,s),this.before=phigl.Framebuffer(t,a,s),this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader","effect_blur")).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/s,1,1,e/a,i/s,-1,-1,0,0,1,-1,e/a,0]).setUniforms("texture","canvasSize"),this.copyDrawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader","effect_copy")).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/s,1,1,e/a,i/s,-1,-1,0,0,1,-1,e/a,0]).setUniforms("texture","alpha"),this.width=e,this.height=i},bindCurrent:function(){this.current.bind()},renderCurrent:function(){var t=this.gl;return t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE),this.drawer.uniforms.texture.setValue(0).setTexture(this.current.texture),this.drawer.uniforms.canvasSize.value=[this.current.width,this.current.height],this.drawer.draw(),this},renderBefore:function(){var t=this.gl;return t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.copyDrawer.uniforms.texture.setValue(0).setTexture(this.before.texture),this.copyDrawer.uniforms.alpha.value=.99,this.copyDrawer.draw(),this},switchFramebuffer:function(){var t=this.current;this.current=this.before,this.before=t}})}),phina.namespace(function(){phina.define("glb.Laser",{superClass:"glb.Shot",player:null,iScaleX:1,iScaleY:1,fScaleX:1,fScaleY:1,init:function(t,e,i){this.superInit(t,e,i)},spawn:function(t){return this.dx=t.dx,this.dy=t.dy,this.player=t.player,glb.Shot.prototype.spawn.call(this,t),this.iScaleX=2*this.scaleX,this.iScaleY=2*this.scaleY,this.fScaleX=1*this.scaleX,this.fScaleY=1*this.scaleY,this},update:function(t){this.bx=this.x,this.by=this.y,this.x=this.player.x,this.y+=this.dy;var e=Math.clamp(this.age/4,0,1);this.scaleY=this.iScaleY+(this.fScaleY-this.iScaleY)*e,glb.Sprite.prototype.update.call(this,t)}})}),phina.namespace(function(){phina.define("glb.Obj",{superClass:"phina.app.Element",id:-1,instanceData:null,visible:!1,position:null,quaternion:null,scale:null,matrix:null,alpha:1,dirty:!0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i,this.position=vec3.create(),this.quaternion=quat.create(),this.scale=vec3.create(),this.matrix=mat4.create()},spawn:function(t){t={}.$extend({visible:!1,x:0,y:0,z:0,rotX:0,rotY:0,rotZ:0,scaleX:OBJ_SCALE,scaleY:OBJ_SCALE,scaleZ:OBJ_SCALE,alpha:1},t);var e=this.index,i=this.instanceData;return this.age=0,this.visible=t.visible,this.x=t.x,this.y=t.y,this.z=t.z,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.scaleZ=t.scaleZ,this.alpha=t.alpha,quat.identity(this.quaternion),quat.rotateZ(this.quaternion,this.quaternion,t.rotZ),quat.rotateY(this.quaternion,this.quaternion,t.rotY),quat.rotateX(this.quaternion,this.quaternion,t.rotX),this.dirty=!0,i[e+0]=this.visible?1:0,this.dirty&&(mat4.fromRotationTranslationScale(this.matrix,this.quaternion,this.position,this.scale),i[e+1]=this.matrix[0],i[e+2]=this.matrix[1],i[e+3]=this.matrix[2],i[e+4]=this.matrix[4],i[e+5]=this.matrix[5],i[e+6]=this.matrix[6],i[e+7]=this.matrix[8],i[e+8]=this.matrix[9],i[e+9]=this.matrix[10],i[e+10]=this.matrix[12],i[e+11]=this.matrix[13],i[e+12]=this.matrix[14],i[e+13]=this.alpha,this.dirty=!1),this},update:function(t){var e=this.index,i=this.instanceData;i[e+0]=this.visible?1:0,this.dirty&&(mat4.fromRotationTranslationScale(this.matrix,this.quaternion,this.position,this.scale),i[e+1]=this.matrix[0],i[e+2]=this.matrix[1],i[e+3]=this.matrix[2],i[e+4]=this.matrix[4],i[e+5]=this.matrix[5],i[e+6]=this.matrix[6],i[e+7]=this.matrix[8],i[e+8]=this.matrix[9],i[e+9]=this.matrix[10],i[e+10]=this.matrix[12],i[e+11]=this.matrix[13],i[e+12]=this.matrix[14],i[e+13]=this.alpha,this.dirty=!1),this.age+=1},onremoved:function(){this.instanceData[this.index+0]=0},rotateX:function(t){return quat.rotateX(this.quaternion,this.quaternion,t),this.dirty=!0,this},rotateY:function(t){return quat.rotateY(this.quaternion,this.quaternion,t),this.dirty=!0,this},rotateZ:function(t){return quat.rotateZ(this.quaternion,this.quaternion,t),this.dirty=!0,this},lookAt:function(t){var e=this.position,i=t.position;quat.identity(this.quaternion),this.rotateZ(Math.atan2(i[1]-e[1],i[0]-e[0]));var a=vec3.sub(vec3.create(),[i[0],i[1],0],[e[0],e[1],0]),s=vec3.sub(vec3.create(),i,e),n=quat.rotationTo(quat.create(),vec3.normalize(a,a),vec3.normalize(s,s));return quat.mul(this.quaternion,this.quaternion,n),this.dirty=!0,this},_accessor:{x:{get:function(){return this.position[0]},set:function(t){this.position[0]=t,this.dirty=!0}},y:{get:function(){return this.position[1]},set:function(t){this.position[1]=t,this.dirty=!0}},z:{get:function(){return this.position[2]},set:function(t){this.position[2]=t,this.dirty=!0}},scaleX:{get:function(){return this.scale[0]},set:function(t){this.scale[0]=t,this.dirty=!0}},scaleY:{get:function(){return this.scale[1]},set:function(t){this.scale[1]=t,this.dirty=!0}},scaleZ:{get:function(){return this.scale[2]},set:function(t){this.scale[2]=t,this.dirty=!0}}}})}),phina.namespace(function(){phina.define("glb.ObjAsset",{superClass:"phina.asset.File",init:function(){this.superInit()},getAttributeData:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e];return i=globj.ObjParser.trialgulate(i),globj.AttributeBuilder.build(i)},getAttributeDataEdges:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e];return i=globj.ObjParser.edge(i),globj.AttributeBuilder.buildEdges(i)}}),phina.asset.AssetLoader.assetLoadFunctions.obj=function(t,e){var i=glb.ObjAsset();return i.load({path:e})}}),phina.namespace(function(){phina.define("glb.ObjDrawer",{gl:null,objTypes:null,counts:null,instanceData:null,instanceVbo:null,ibos:null,vbos:null,textures:null,pools:null,faceDrawer:null,init:function(t,e,i,a){this.gl=t,this.objTypes=[],this.counts={},this.instanceData={},this.instanceVbo={},this.ibos={},this.vbos={},this.textures={},this.pools={},this.faceDrawer=phigl.InstancedDrawable(t,e).setProgram(phina.asset.AssetManager.get("shader","obj")).setAttributes("position","uv","normal").setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3","instanceAlpha").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition","texture"),this.glowDrawer=phigl.InstancedDrawable(t,e).setProgram(phina.asset.AssetManager.get("shader","objGlow")).setAttributes("position","uv","normal").setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3","instanceAlpha").setUniforms("vpMatrix","texture"),this.lightDirection=vec3.set(vec3.create(),1,-.5,0),vec3.normalize(this.lightDirection,this.lightDirection),this.diffuseColor=[.5,.5,.5,1],this.ambientColor=[.5,.5,.5,1]},addObjType:function(t,e,i,a){a=a||"glb.Obj",i=i||1;var s=this,n=this.faceDrawer.instanceStride/4;if(!this.objTypes.contains(t)){this.counts[t]=i;var r=this.instanceData[t]=Array.range(i).map(function(t){return[0,1,0,0,0,1,0,0,0,1,0,0,0,1]}).flatten();this.instanceVbo[t]=phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW).set(r),this.ibos[t]=phina.asset.AssetManager.get("ibo",e+".obj"),this.vbos[t]=phina.asset.AssetManager.get("vbo",e+".obj"),this.textures[t]=phina.asset.AssetManager.get("texture",e+".png");var o=phina.using(a);this.pools[t]=Array.range(i).map(function(e){return o(e,r,n).on("removed",function(){s.pools[t].push(this)})}),this.objTypes.push(t)}},get:function(t){return this.pools[t].shift()},update:function(t){},render:function(t){var e=this,i=this.gl;i.enable(i.BLEND),i.enable(i.DEPTH_TEST),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.faceDrawer.uniforms.lightDirection.value=this.lightDirection,this.faceDrawer.uniforms.diffuseColor.value=this.diffuseColor,this.faceDrawer.uniforms.ambientColor.value=this.ambientColor,t&&t.forIn(function(t,e){this.faceDrawer.uniforms[t]&&(this.faceDrawer.uniforms[t].value=e)}.bind(this)),this.objTypes.forEach(function(t){var i=e.counts[t],a=e.instanceData[t],s=e.instanceVbo[t],n=e.ibos[t],r=e.vbos[t],o=e.textures[t];try{s.set(a),e.faceDrawer.setIndexBuffer(n).setAttributeVbo(r).setInstanceAttributeVbo(s),e.faceDrawer.uniforms.texture.setValue(0).setTexture(o),e.faceDrawer.draw(i)}catch(h){throw console.error("obj draw error",t,a.length),h}})},renderGlow:function(t){var e=this,i=this.gl;i.enable(i.BLEND),i.enable(i.DEPTH_TEST),i.blendFunc(i.SRC_ALPHA,i.ONE),t&&t.forIn(function(t,e){this.glowDrawer.uniforms[t]&&(this.glowDrawer.uniforms[t].value=e)}.bind(this)),this.objTypes.forEach(function(t){var i=e.counts[t],a=e.instanceData[t],s=e.instanceVbo[t],n=e.ibos[t],r=e.vbos[t],o=e.textures[t];try{s.set(a),e.glowDrawer.setIndexBuffer(n).setAttributeVbo(r).setInstanceAttributeVbo(s),e.glowDrawer.uniforms.texture.setValue(0).setTexture(o),e.glowDrawer.draw(i)}catch(h){throw console.error("obj-glow draw error",t,a.length),h}})}})}),phina.namespace(function(){phina.define("glb.Player",{superClass:"glb.Obj",hp:10,mutekiTime:0,controllable:!1,bits:null,shift:-1,roll:0,tweener2:null,init:function(t,e,i){this.superInit(t,e,i),this.roll=0,this.bits=[],this.tweener2=phina.accessory.Tweener().attachTo(this)},spawn:function(){return glb.Obj.prototype.spawn.call(this,{visible:!1,x:.5*SCREEN_WIDTH,y:1.2*SCREEN_HEIGHT,rotZ:(-90).toRadian(),scaleX:20,scaleY:20,scaleZ:20}),this},launch:function(){this.tweener.clear().set({x:.5*SCREEN_WIDTH,y:1.2*SCREEN_HEIGHT,visible:!0,controllable:!1,roll:a}).to({y:.8*SCREEN_HEIGHT,roll:0},1e3,"easeOutBack").set({controllable:!0,mutekiTime:90,shift:-1}).call(function(){this.flare("launched")}.bind(this)).wait(3e3),this.tweener2.clear().set({scaleX:100,scaleY:100,scaleZ:100}).to({scaleX:20,scaleY:20,scaleZ:20},1e3)},setBitJoin:function(t){this.bitJoin=t,t.spawn({visible:!0,scaleX:20,scaleY:20,scaleZ:20,rotZ:(-90).toRadian()})},setBarrier:function(t){return this.barrier=t,t.spawn({scaleX:20,scaleY:20,scaleZ:20,rotZ:(-90).toRadian()}),this},update:function(a){this.controllable&&this.control(a),this.shift<0&&(this.shift=Math.min(this.shift+.1,0));var s=this.index,h=this.instanceData;quat.copy(this.quaternion,t),quat.rotateX(this.quaternion,this.quaternion,this.roll);for(var l=this.shift,u=0;4>u;u++){var c=this.bits[u],p=n[u],d=r[u],f=o[u];if(0>l)var m=p.x*-l+d.x*(1+l),b=p.y*-l+d.y*(1+l),g=p.d*-l+d.d*(1+l);else var m=d.x*(1-l)+f.x*l,b=d.y*(1-l)+f.y*l,g=d.d*(1-l)+f.d*l;c&&(c.visible=this.controllable&&this.shift<1,c.visible&&(c.x=this.x+m,c.y=this.y+b,quat.setAxisAngle(c.quaternion,[0,0,1],g),c.rotateX(this.age*(2>u?.2:-.2))))}var y=this.bitJoin;y.visible=this.controllable&&1===this.shift,y&&(y.x=this.x,y.y=this.y+-50,y.rotateX(.2));var x=this.barrier;x&&(x.visible=this.muteki,x.visible&&(x.x=this.x,x.y=this.y,x.rotateX(.5))),h[s+0]=this.visible?1:0,this.dirty&&(quat.mul(i,e,this.quaternion),mat4.fromRotationTranslationScale(this.matrix,i,this.position,this.scale),h[s+1]=this.matrix[0],h[s+2]=this.matrix[1],h[s+3]=this.matrix[2],h[s+4]=this.matrix[4],h[s+5]=this.matrix[5],h[s+6]=this.matrix[6],h[s+7]=this.matrix[8],h[s+8]=this.matrix[9],h[s+9]=this.matrix[10],h[s+10]=this.matrix[12],h[s+11]=this.matrix[13],h[s+12]=this.matrix[14],h[s+13]=this.alpha,this.dirty=!1),this.age+=1,this.mutekiTime-=1},control:function(t){var e=t.ticker.frame,i=t.keyboard,a=t.gamepadManager.get(),n=i.getKeyDirection(),r=a.getStickDirection();if(r.length()>.5){var o=0,h=0;r.x<-.5?o=-1:.5<r.x&&(o=1),r.y<-.5?h=-1:.5<r.y&&(h=1),n.add(phina.geom.Vector2(o,h).normalize())}n.add(a.getKeyDirection()),n.normalize();var l=i.getKey("LASER")||a.getKey("LASER")?13:24;this.x=Math.clamp(this.x+n.x*l,10,SCREEN_WIDTH-10),this.y=Math.clamp(this.y+n.y*l,10,SCREEN_HEIGHT-10),n.x?this.roll=Math.clamp(this.roll-.2*n.x,-s,s):this.roll<-.2?this.roll+=.2:.2<this.roll?this.roll-=.2:this.roll=0;var u=i.getKey("SHOT")||a.getKey("SHOT"),c=i.getKey("LASER")||a.getKey("LASER");this.shift>=0&&(i.getKey("LASER")||a.getKey("LASER")?this.shift=Math.min(this.shift+.2,1):this.shift=Math.max(this.shift-.2,0)),u&&0<=this.shift&&this.shift<1&&e%2===0?this.shot():c&&1==this.shift&&this.laser()},hitBullet:function(t){},hitEnemy:function(t){},laser:function(){var t=[6,7,8].pickup();this.flare("fireLaser",{x:this.x,y:this.y-40,rotation:Math.PI*-.5,scaleX:15,scaleY:Math.randfloat(1.8,2.2),frameX:t%8,frameY:~~(t/8),alpha:1,dx:0,dy:-150,player:this})},shot:function(){for(var t=-2;2>t;t++)this.flare("fireShot",{x:this.x+20*t+10,y:this.y-20,rotation:Math.PI*-.5,scaleX:4,scaleY:4,frameX:[1,2,3,4].pickup(),frameY:1,alpha:1,dx:0,dy:-90});var e=this.shift;if(!(0>e))for(var t=0;4>t;t++){var i=n[t],a=r[t],s=o[t];if(0>e)var h=i.x*-e+a.x*(1+e),l=i.y*-e+a.y*(1+e),u=i.d*-e+a.d*(1+e),c=i.cw*-e+a.cw*(1+e),p=i.sw*-e+a.sw*(1+e),d=i.cr*-e+a.cr*(1+e),f=i.sr*-e+a.sr*(1+e);else var h=a.x*(1-e)+s.x*e,l=a.y*(1-e)+s.y*e,u=a.d*(1-e)+s.d*e,c=a.cw*(1-e)+s.cw*e,p=a.sw*(1-e)+s.sw*e,d=a.cr*(1-e)+s.cr*e,f=a.sr*(1-e)+s.sr*e;[-1,1].forEach(function(t){this.flare("fireShot",{x:this.x+h+15*c*t+30*d,y:this.y+l+15*p*t+30*f,rotation:u,scaleX:4,scaleY:4,frameX:[1,2,3,4].pickup(),frameY:1,alpha:1,dx:90*d,dy:90*f})}.bind(this))}},_accessor:{muteki:{get:function(){return!this.controllable||this.mutekiTime>0},set:function(){}}}});var t=quat.rotateZ(quat.create(),quat.create(),(-90).toRadian()),e=quat.setAxisAngle(quat.create(),[1,0,0],10..toRadian()),i=quat.create(),a=(360..toRadian(),180..toRadian()),s=90..toRadian(),n=(45..toRadian(),22.5.toRadian(),[{x:0,y:0,d:(-90).toRadian(),sr:Math.sin((-90).toRadian()),cr:Math.cos((-90).toRadian()),sw:Math.sin(0..toRadian()),cw:Math.cos(0..toRadian())},{x:0,y:0,d:(-90).toRadian(),sr:Math.sin((-90).toRadian()),cr:Math.cos((-90).toRadian()),sw:Math.sin(0..toRadian()),cw:Math.cos(0..toRadian())},{x:0,y:0,d:(-90).toRadian(),sr:Math.sin((-90).toRadian()),cr:Math.cos((-90).toRadian()),sw:Math.sin(0..toRadian()),cw:Math.cos(0..toRadian())},{x:0,y:0,d:(-90).toRadian(),sr:Math.sin((-90).toRadian()),cr:Math.cos((-90).toRadian()),sw:Math.sin(0..toRadian()),cw:Math.cos(0..toRadian())}]),r=[{x:-120,y:35,d:(-110).toRadian(),sr:Math.sin((-110).toRadian()),cr:Math.cos((-110).toRadian()),sw:Math.sin((-20).toRadian()),cw:Math.cos((-20).toRadian())},{x:-70,y:20,d:(-100).toRadian(),sr:Math.sin((-100).toRadian()),cr:Math.cos((-100).toRadian()),sw:Math.sin((-10).toRadian()),cw:Math.cos((-10).toRadian())},{x:70,y:20,d:(-80).toRadian(),sr:Math.sin((-80).toRadian()),cr:Math.cos((-80).toRadian()),sw:Math.sin(10..toRadian()),cw:Math.cos(10..toRadian())},{x:120,y:35,d:(-70).toRadian(),sr:Math.sin((-70).toRadian()),cr:Math.cos((-70).toRadian()),sw:Math.sin(20..toRadian()),cw:Math.cos(20..toRadian())}],o=[{x:0,y:-50,d:(-84).toRadian(),sr:Math.sin((-84).toRadian()),cr:Math.cos((-84).toRadian()),sw:Math.sin(6..toRadian()),cw:Math.cos(6..toRadian())},{x:0,y:-50,d:(-87).toRadian(),sr:Math.sin((-87).toRadian()),cr:Math.cos((-87).toRadian()),sw:Math.sin(3..toRadian()),cw:Math.cos(3..toRadian())},{x:0,y:-50,d:(-93).toRadian(),sr:Math.sin((-93).toRadian()),cr:Math.cos((-93).toRadian()),sw:Math.sin((-3).toRadian()),cw:Math.cos((-3).toRadian())},{x:0,y:-50,d:(-96).toRadian(),sr:Math.sin((-96).toRadian()),cr:Math.cos((-96).toRadian()),sw:Math.sin((-6).toRadian()),cw:Math.cos((-6).toRadian())}]}),phina.namespace(function(){phina.define("glb.Pool",{array:null,dirty:null,comparator:null,init:function(t,e){this.array=t||[],this.comparator=e||function(t,e){return t-e},this.dirty=!0},add:function(t){this.array.push(t),this.dirty=!0},get:function(){return this.dirty&&(this.array.sort(this.comparator),this.dirty=!1),this.array.shift()}}),Array.prototype.$method("toPool",function(t){return glb.Pool(this,t)})}),phina.namespace(function(){phina.define("glb.PostProcessing",{gl:null,drawer:null,width:0,height:0,init:function(t,e,i,a,s){this.gl=t;var n=Math.pow(2,~~Math.log2(e)+1),r=Math.pow(2,~~Math.log2(i)+1);this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader",a)).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/r,1,1,e/n,i/r,-1,-1,0,0,1,-1,e/n,0]).setUniforms(["texture","canvasSize"].concat(s)),this.width=e,this.height=i,this.sw=n,this.sh=r},render:function(t,e,i){var a=this.gl;return a.enable(a.BLEND),
a.disable(a.DEPTH_TEST),i?a.blendFunc(a.SRC_ALPHA,a.ONE):a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.drawer.uniforms.texture.setValue(0).setTexture(t),this.drawer.uniforms.canvasSize.value=[this.sw,this.sh],e&&this.setUniforms(e),this.drawer.draw(),this},setUniforms:function(t){var e=this.drawer.uniforms;t.forIn(function(t,i){e[t].value=i})},viewCoordToShaderCoord:function(t,e){var i=glb.GLLayer.quality;return[t*i/this.sw,(SCREEN_HEIGHT-e)*i/this.sh]}})}),phina.namespace(function(){phina.define("glb.Shot",{superClass:"glb.Sprite",power:0,bx:0,by:0,_active:!1,init:function(t,e,i){this.superInit(t,e,i)},spawn:function(t){return this.dx=t.dx,this.dy=t.dy,glb.Sprite.prototype.spawn.call(this,t),this.bx=this.x,this.by=this.y,this},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},update:function(t){this.bx=this.x,this.by=this.y,this.x+=this.dx,this.y+=this.dy,glb.Sprite.prototype.update.call(this,t)},hitEnemy:function(t){this.flare("hitEnemy",{enemy:t}),this.remove()}})}),phina.namespace(function(){phina.define("glb.Sprite",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,rotation:0,scale:0,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){t.$safe({x:0,y:0,rotation:0,scale:1,frameX:0,frameY:0,alpha:1});var e=this.index,i=this.instanceData;return this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.frameX=t.frameX,this.frameY=t.frameY,this.alpha=t.alpha,i[e+0]=1,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.alpha,this.age=0,this},update:function(t){var e=this.index,i=this.instanceData;return this.x<-100||740<this.x||this.y<-100||1060<this.y?void this.remove():(i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scaleX,i[e+5]=this.scaleY,i[e+6]=this.frameX,i[e+7]=this.frameY,i[e+8]=this.alpha,void(this.age+=1))},onremoved:function(){this.instanceData[this.index+0]=0}})}),phina.namespace(function(){phina.define("glb.SpritDrawer",{superClass:"phigl.InstancedDrawable",objTypes:null,counts:null,instanceData:null,textures:null,pools:null,additiveBlending:!0,init:function(t,e,i,a){this.superInit(t,e),this.objTypes=[],this.counts={},this.instanceData={},this.instanceVbos={},this.textures={},this.pools={},this.setProgram(phina.asset.AssetManager.get("shader","sprites")).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,1/8,1/8,1/8,0,0,1/8,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceAlpha").setUniforms("vpMatrix","texture","globalScale");this.instanceStride/4;this.uniforms.globalScale.setValue(1)},addObjType:function(t,e,i,a){a=a||"glb.Sprite",i=i||1;var s=this,n=this.instanceStride/4;if(!this.objTypes.contains(t)){this.counts[t]=i;var r=this.instanceData[t]=Array.range(i).map(function(t){return[0,1,0,0,0,1,0,0,0,1,0,0,0]}).flatten();this.instanceVbos[t]=phigl.Vbo(this.gl,this.gl.DYNAMIC_DRAW),this.textures[t]=phina.asset.AssetManager.get("texture",e+".png");var o=phina.using(a);this.pools[t]=Array.range(i).map(function(e){return o(e,r,n).on("removed",function(){s.pools[t].push(this)})}),this.objTypes.push(t)}},_createTexture:function(){var t=phina.graphics.Canvas().setSize(512,512),e=t.context,i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255, 255, 255, 0.3)"),i.addColorStop(.6,"rgba(255, 125,   0, 0.3)"),i.addColorStop(1,"rgba(255,   0,   0, 0.0)"),e.fillStyle=i,e.fillRect(0,0,64,64),t},get:function(t){return this.pools[t].shift()},update:function(){},render:function(t){var e=this.gl;e.enable(e.BLEND),this.additiveBlending?e.blendFunc(e.SRC_ALPHA,e.ONE):e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.disable(e.DEPTH_TEST),this.uniforms.globalScale.value=1,t&&t.forIn(function(t,e){this.uniforms[t]&&(this.uniforms[t].value=e)}.bind(this));var i=this;this.objTypes.forEach(function(t){var e=i.counts[t],a=i.instanceData[t],s=i.instanceVbos[t],n=i.textures[t];s.set(a),i.setInstanceAttributeVbo(s),i.uniforms.texture.setValue(0).setTexture(n),i.draw(e)})}})}),phina.namespace(function(){phina.define("glb.TerrainDrawer",{gl:null,faceDrawer:null,edgeDrawer:null,instanceData:null,pool:null,count:0,init:function(t,e,i,a){this.gl=t,this.count=2*glb.TerrainDrawer.countX*(2*glb.TerrainDrawer.countZ),this.faceDrawer=phigl.InstancedDrawable(t,e),this.edgeDrawer=phigl.InstancedDrawable(t,e);for(var s=this.instanceData=[],n=0;n<this.count;n++)s.push(0,1,0,0,0,1,0,0,0,1,0,0,0,1);this.faceDrawer.setProgram(phina.asset.AssetManager.get("shader","terrain")).setIndexBuffer(phina.asset.AssetManager.get("ibo","hex.obj")).setAttributes("position","uv","normal").setAttributeVbo(phina.asset.AssetManager.get("vbo","hex.obj")).setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3","instanceAlpha").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition"),this.edgeDrawer.setDrawMode(t.LINES).setProgram(phina.asset.AssetManager.get("shader","terrainEdge")).setIndexBuffer(phina.asset.AssetManager.get("edgesIbo","hex.obj")).setAttributes("position").setAttributeVbo(phina.asset.AssetManager.get("edgesVbo","hex.obj")).setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3","instanceAlpha").setUniforms("vpMatrix","cameraPosition","color");var r=this.edgeDrawer.instanceStride/4;this.lightDirection=vec3.set(vec3.create(),-1,-.5,0),vec3.normalize(this.lightDirection,this.lightDirection);var o=this;this.pool=Array.range(0,this.count).map(function(t){return glb.Obj(t,s,r).on("enterframe",function(){this.x+=.06,this.z+=.2;var t=glb.TerrainDrawer.countX,e=glb.TerrainDrawer.countZ,i=glb.TerrainDrawer.unit;this.x<-t*i?this.x+=t*i*2:t*i<this.x&&(this.x-=t*i*2),this.z<-e*i*1/Math.sqrt(3)*1.5?this.z+=e*i*1/Math.sqrt(3)*1.5*2:e*i*1/Math.sqrt(3)*1.5<this.z&&(this.z-=e*i*1/Math.sqrt(3)*1.5*2)}).on("removed",function(){o.pool.push(this)})}),this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData)},update:function(t){.003*t.ticker.frame},get:function(){return this.pool.shift()},render:function(t){var e=this.gl;e.enable(e.BLEND),e.enable(e.DEPTH_TEST),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData),this.faceDrawer.uniforms.lightDirection.value=this.lightDirection,this.faceDrawer.uniforms.ambientColor.value=[.05,.05,.05,.7],this.edgeDrawer.uniforms.color.value=[1,1,1,1],t&&t.forIn(function(t,e){this.edgeDrawer.uniforms[t]&&(this.edgeDrawer.uniforms[t].value=e),this.faceDrawer.uniforms[t]&&(this.faceDrawer.uniforms[t].value=e)}.bind(this)),this.edgeDrawer.draw(this.count),this.faceDrawer.draw(this.count)},_static:{countX:12,countZ:22,unit:2.05}})}),phina.namespace(function(){phina.asset.AssetLoader.assetLoadFunctions.textureSource=function(t,e){var i=phina.asset.Texture(),a=i.load(e);return a}}),phina.namespace(function(){phina.define("glb.Assets",{_static:{get:function(t){switch(t.assetType){case"common":return{obj:{"fighter.obj":"./asset/obj/fighter.obj","bit.obj":"./asset/obj/bit.obj","bitJoin.obj":"./asset/obj/bitJoin.obj","hex.obj":"./asset/obj/hex.obj","barrier.obj":"./asset/obj/barrier.obj"},textureSource:{"fighter.png":"./asset/image/fighter.png","bit.png":"./asset/image/bit.png","bitJoin.png":"./asset/image/bit.png","bullets.png":"./asset/image/bullets.png","effect.png":"./asset/image/effect.png","barrier.png":"./asset/image/barrier.png"},vertexShader:{"bullets.vs":"./asset/shader/bullets.vs","sprites.vs":"./asset/shader/sprites.vs","terrain.vs":"./asset/shader/terrain.vs","terrainEdge.vs":"./asset/shader/terrainEdge.vs","obj.vs":"./asset/shader/obj.vs","objEdge.vs":"./asset/shader/objEdge.vs","objGlow.vs":"./asset/shader/objGlow.vs","postproccess_copy.vs":"./asset/shader/postproccess.vs","postproccess_blur.vs":"./asset/shader/postproccess.vs","postproccess_zoom.vs":"./asset/shader/postproccess.vs"},fragmentShader:{"bullets.fs":"./asset/shader/bullets.fs","sprites.fs":"./asset/shader/sprites.fs","terrain.fs":"./asset/shader/terrain.fs","terrainEdge.fs":"./asset/shader/terrainEdge.fs","obj.fs":"./asset/shader/obj.fs","objEdge.fs":"./asset/shader/objEdge.fs","objGlow.fs":"./asset/shader/objGlow.fs","postproccess_copy.fs":"./asset/shader/postproccess_copy.fs","postproccess_blur.fs":"./asset/shader/postproccess_blur.fs","postproccess_zoom.fs":"./asset/shader/postproccess_zoom.fs"}};case"stage1":return{obj:{"enemyS1.obj":"./asset/obj/enemyS1.obj","enemyS2.obj":"./asset/obj/enemyS2.obj","enemyS3.obj":"./asset/obj/enemyS3.obj","enemyS4.obj":"./asset/obj/enemyS4.obj","enemyS5.obj":"./asset/obj/enemyS5.obj","enemyM1.obj":"./asset/obj/enemyM1.obj"},textureSource:{"enemyS1.png":"./asset/image/enemyS1.png","enemyS2.png":"./asset/image/enemyS2.png","enemyS3.png":"./asset/image/enemyS3.png","enemyS4.png":"./asset/image/enemyS4.png","enemyS5.png":"./asset/image/enemyS5.png","enemyM1.png":"./asset/image/enemyM1.png"}};default:throw"invalid assetType: "+t.assetType}}}})}),phina.namespace(function(){phina.define("glb.Danmaku",{init:function(){},_static:{_initialized:!1,config:{},intervalRate:1,speedRate:15,initialize:function(){this._initialized=!0;var a=e({type:2}),r=e({type:10});this.basic0=new bulletml.Root({top:t([s(1/0,[o(30),i(h(1),a),o(30),i(h(1),r)])])}),this.basic1=new bulletml.Root({top:t([s(1/0,[o(30),i(h(1),a),s(4,[o(4),i(l(0),u(0),a)])])])}),this.basic2=new bulletml.Root({top:t([s(1/0,[o(30),i(n(-15),h(1),a),s(2,[i(l(15),h(1),a)])])])}),this.basic3=new bulletml.Root({top:t([s(1/0,[o(30),i(n(-8),h(1),a),s(2,[i(l(8),h(1),a)])])])}),this.test=new bulletml.Root({top:t([s(1/0,[i(l(1),h(1),a),s(89,[i(l(4),h(1),a)]),o(5)])])})},createRunner:function(t){return this._initialized||this.initialize(),this[t].createRunner(this.config)}}});var t=bulletml.dsl.action,e=(bulletml.dsl.actionRef,bulletml.dsl.bullet),i=(bulletml.dsl.bulletRef,bulletml.dsl.fire),a=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),s=(bulletml.dsl.vanish,bulletml.dsl.repeat),n=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction),r=bulletml.dsl.speed,o=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY,bulletml.dsl.autonomy,function(t){return a(Math.max(t*glb.Danmaku.intervalRate,1))}),h=function(t){return r(t*glb.Danmaku.speedRate)},l=function(t){return n(t,"sequence")},u=function(t){return r(t,"sequence")}}),phina.namespace(function(){phina.define("glb.Enemy",{superClass:"glb.Obj",_static:{data:{}},_active:!1,hp:10,mutekiTime:0,runner:null,pattern:0,radius:50,init:function(t,e,i){this.superInit(t,e,i),this.on("removed",function(){this.runner=null})},activate:function(){return this._active=!0,this.flare("activated"),this},inactivate:function(){return this._active=!1,this.flare("inactivated"),this},update:function(i){var a=this.index,s=this.instanceData;s[a+0]=this.visible?1:0,this.dirty&&(quat.mul(e,t,this.quaternion),mat4.fromRotationTranslationScale(this.matrix,e,this.position,this.scale),s[a+1]=this.matrix[0],s[a+2]=this.matrix[1],s[a+3]=this.matrix[2],s[a+4]=this.matrix[4],s[a+5]=this.matrix[5],s[a+6]=this.matrix[6],s[a+7]=this.matrix[8],s[a+8]=this.matrix[9],s[a+9]=this.matrix[10],s[a+10]=this.matrix[12],s[a+11]=this.matrix[13],s[a+12]=this.matrix[14],s[a+13]=this.alpha,this.dirty=!1),this.runner&&(this.runner.x=this.x,this.runner.y=this.y,this.runner.update()),this.age+=1,this.mutekiTime-=1},hitShot:function(t){this.mutekiTime>0&&(this.hp-=t.power,this.mutekiTime=1,this.flare("damaged"))},hitPlayer:function(t){},setRunner:function(t){return this.runner=glb.Danmaku.createRunner(t),this},setPattern:function(t){return this.pattern=t,this}});var t=quat.setAxisAngle(quat.create(),[1,0,0],45..toRadian()),e=quat.create()}),phina.namespace(function(){phina.define("glb.EnemyS1",{superClass:"glb.Enemy",init:function(t,e,i){this.superInit(t,e,i)}}),glb.Enemy.data.enemyS1={count:100,className:"glb.EnemyS1"}}),phina.namespace(function(){phina.define("glb.DownloadScene",{superClass:"phina.game.LoadingScene",init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"black",assets:glb.Assets.get({assetType:t.assetType})}),this.fromJSON({children:{label:{className:"phina.display.Label",arguments:"downloading",x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,fill:"white",stroke:null}}})}})}),phina.namespace(function(){phina.define("glb.ErrorScene",{superClass:"phina.display.DisplayScene",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"black"}),this.fromJSON({children:{label:{className:"phina.display.Label",arguments:"error: "+glb.ErrorScene.message,x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,fill:"white",stroke:null}}})},_static:{message:""}})}),phina.namespace(function(){phina.define("glb.LoadScene",{superClass:"phina.display.DisplayScene",init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,backgroundColor:"black"}),this.gl=t.gl,this.assetType=t.assetType,this.totalCount=0,this.count=0,this.fromJSON({children:{label:{className:"phina.display.Label",arguments:"loading",x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,fill:"white",stroke:null}}}),this.tweener.wait(66).call(function(){this.load()}.bind(this))},onprogress:function(){this.count+=1,this.label.text=this.count+"/"+this.totalCount},oncomplete:function(){this.app.popScene()},load:function(){var t=this,e=this.gl,i=phina.asset.AssetManager;this.totalCount=Object.keys(i.assets.vertexShader).length+Object.keys(i.assets.obj).length+Object.keys(i.assets.textureSource).length;var a=[];return i.assets.vertexShader.forIn(function(s,n){var r=phina.util.Flow(function(a){var n=s.replace(".vs",""),r=phigl.Program(e).attach(n+".vs").attach(n+".fs").link();i.set("shader",n,r),t.flare("progress"),a()});a.push(r)}),i.assets.obj.forIn(function(s,n){var r=phina.util.Flow(function(a){var r=n.getAttributeData(),o=n.getAttributeDataEdges(),h=phigl.Vbo(e).set(r.attr),l=phigl.Ibo(e).set(r.indices),u=phigl.Vbo(e).set(o.attr),c=phigl.Ibo(e).set(o.indices);i.set("vbo",s,h),i.set("ibo",s,l),i.set("edgesVbo",s,u),i.set("edgesIbo",s,c),t.flare("progress"),a()});a.push(r)}),i.assets.textureSource.forIn(function(s,n){var r=phina.util.Flow(function(a){var r=phigl.Texture(e,n);i.set("texture",s,r),t.flare("progress"),a()});a.push(r)}),phina.util.Flow.all(a).then(function(){t.flare("complete")}),this},_static:{deleteAssets:function(t){var e=glb.Assets.get(t),i=phina.asset.AssetManager;e.obj&&e.obj.forIn(function(t){i.get("vbo",t)&&(i.get("vbo",t)["delete"](),delete i.assets.vbo[t]),i.get("ibo",t)&&(i.get("ibo",t)["delete"](),delete i.assets.ibo[t]),i.get("edgesVbo",t)&&(i.get("edgesVbo",t)["delete"](),delete i.assets.edgesVbo[t]),i.get("edgesIbo",t)&&(i.get("edgesIbo",t)["delete"](),delete i.assets.edgesIbo[t]),i.assets.obj&&delete i.assets.obj[t]}),e.textureSource&&e.textureSource.forIn(function(t,e){i.get("texture",t)&&(i.get("texture",t)["delete"](),delete i.assets.texture[t]),i.assets.textureSource&&delete i.assets.textureSource[t]})}}})}),phina.namespace(function(){phina.define("glb.SceneFlow",{superClass:"phina.game.ManagerScene",init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,scenes:[{label:"download-common",className:"glb.DownloadScene",arguments:{}.$extend(t,{assetType:"common"})},{label:"arcade",className:"glb.ArcadeMode",arguments:{}.$extend(t,{})}]})}}),phina.define("glb.ArcadeMode",{superClass:"phina.game.ManagerScene",init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT,scenes:[{label:"download-stage1",className:"glb.DownloadScene",arguments:{}.$extend(t,{assetType:"stage1"})},{label:"load-stage1",className:"glb.LoadScene",arguments:{}.$extend(t,{assetType:"stage1"})},{label:"stage",className:"glb.StageScene",arguments:{}.$extend(t,{assetType:"stage1"})}]})}})}),phina.namespace(function(){phina.define("glb.StageScene",{superClass:"phina.display.DisplayScene",collisions:null,explosion:null,player:null,stage:null,init:function(t){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.fromJSON({children:{glLayer:{className:"glb.GLLayer",arguments:{canvas:t.canvas,gl:t.gl}},uiLayer:{className:"glb.UILayer"}}});var e=this,i=this.glLayer,a=(this.uiLayer,this.collisions=glb.Collisions()),s=this.explosion=glb.Explosion(i),n=this.player=i.playerDrawer.get("fighter"),r=this.stage=glb.Stage();r.on("enemyTask",function(t){e.launchEnemy(t.name,t.pattern,t.runner,t.x,t.y)}),r.on("spawnerTask",function(t){glb.Spawner(t).on("spawn",function(t){e.launchEnemy(t.name,t.pattern,t.runner,t.x,t.y)}).addChildTo(e)}),this.on("enterframe",function(t){a.update(t.app)}),glb.Danmaku.config.target=n,glb.Danmaku.config.createNewBullet=function(t,e){var s=i.bulletDrawer.get();s&&(s.spawn(t,e).addChildTo(i),a.addBullet(s))},Object.keys(glb.Assets.get({assetType:t.assetType}).obj).map(function(t){return t.replace(".obj","")}).forEach(function(t){var e=glb.Enemy.data[t]||{};i.enemyDrawer.addObjType(t,t,e.count||100,e.className||"glb.Enemy")}),n.spawn().addChildTo(i).on("fireShot",function(t){var e=i.spriteDrawer.get("shot");e&&(e.spawn(t).addChildTo(i),a.addShot(e),e.has("hitEnemy")||e.on("hitEnemy",function(t){s.spark(t.enemy.x,t.enemy.y)}))}).on("fireLaser",function(t){var e=i.spriteDrawer.get("laser");e&&(e.spawn(t).addChildTo(i),a.addShot(e),e.has("hitEnemy")||e.on("hitEnemy",function(t){s.small(t.enemy.x,t.enemy.y)}));var n=i.spriteDrawer.get("effect");if(n){var r=Math.randfloat(6,8);n.spawn({x:t.x,y:t.y-20,rotation:(-90).toRadian(),scaleX:r,scaleY:r,frameX:5,frameY:1,alpha:.8}).addChildTo(i),n.tweener.clear().wait(20).call(function(){n.remove()})}}).on("launched",function(){}),a.setPlayer(n),[-2,-1,1,2].forEach(function(t){var e=i.playerDrawer.get("bit").spawn({x:SCREEN_WIDTH/2,y:SCREEN_HEIGHT/2,scaleX:20,scaleY:20,scaleZ:20,rotZ:(-90+10*t).toRadian()}).addChildTo(i);n.bits.push(e)});var o=i.playerDrawer.get("bitJoin").addChildTo(i);n.setBitJoin(o);var h=i.playerDrawer.get("barrier").addChildTo(i);n.setBarrier(h);for(var l=0;5>l;l++){var u=this.launchEnemy("enemyS"+Math.randint(1,5),0,"basic0",Math.randfloat(.1,.9)*SCREEN_WIDTH,Math.randfloat(.1,.5)*SCREEN_HEIGHT);u&&quat.setAxisAngle(u.quaternion,[0,0,1],90..toRadian())}n.launch()},launchEnemy:function(t,e,i,a,s){var n=this.glLayer,r=n.enemyDrawer.get(t);return r?(r.spawn({visible:!0,x:a,y:s}).setRunner(i).setPattern(e).addChildTo(n),this.collisions.addEnemy(r),r):void 0},update:function(t){this.stage.update(),t.keyboard.getKeyDown("p")&&t.canvas.saveAsImage(),t.keyboard.getKeyDown("l")&&this.player.launch()}})}),phina.namespace(function(){phina.define("glb.Stage",{superClass:"phina.app.Element",seq:null,waitTime:0,init:function(){this.superInit(),this.seq=[]},update:function(){if(this.waitTime-=1,!(this.waitTime>0)){var t=this.seq.shift();t&&this.fire(t)}},addTask:function(t){return this.seq.push(t),this},onwaitTask:function(t){this.waitTime=t.time},onstartBgmTask:function(t){phina.asset.SoundManager.playMusic(t.name,t.fadeTime,t.loop)}})}),phina.namespace(function(){phina.define("glb.Stage1",{superClass:"glb.Stage",init:function(){this.superInit(),this.addTask({type:"waitTask",time:1e3}).addTask({type:"enemyTask",name:"",pattern:0,runner:"",x:0,y:0})}})}),phina.namespace(function(){Array.prototype.$method("uniq",function(t){return t?this.filter(function(e,i,a){return!a.slice(0,i).some(function(i){return t(e,i)})}):this.filter(function(t,e,i){return i.indexOf(t)===e})})});