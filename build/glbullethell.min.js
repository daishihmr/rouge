phina.namespace(function(){phina.define("glb.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.instanceStride=e},spawn:function(t,i){var e=this.id,s=this.instanceData,a=this.instanceStride;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,s[e*a+0]=this.x,s[e*a+1]=this.y,s[e*a+2]=t.direction,s[e*a+3]=1.5,s[e*a+4]=i.type%8,s[e*a+5]=~~(i.type/8),s[e*a+6]=1,s[e*a+7]=1,s[e*a+8]=.2+~~(i.type/8)%2,s[e*a+9]=.2,s[e*a+10]=.2+~~(i.type/8)%2+1;var n=this;return t.onVanish=function(){n.remove()},this},update:function(t){var i=this.id,e=this.instanceData,s=this.instanceStride,a=this.runner;a.update(),this.x=a.x,this.y=a.y,(this.x<-100||740<this.x||this.y<-100||1060<this.y)&&this.remove(),e[i*s+0]=this.x,e[i*s+1]=this.y,e[i*s+7]=1.5+.6*Math.sin(.2*this.age),this.age+=1}})}),phina.namespace(function(){phina.define("glb.BulletSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:1e3,init:function(t,i,e,s){this.superInit(t,i),this.setProgram(phigl.Program(t).attach("bulletSprites.vs").attach("bulletSprites.fs").link()).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vMatrix","pMatrix","texture","globalScale");var a=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[e/2,s/2,1e3],[e/2,s/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-e/2,e/2,s/2,-s/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,"bullets.png")),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(n);var h=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Bullet(t,n,a).on("removed",function(){h.pool.push(this),n[this.id*a+6]=0})})},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.Effect",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,rotation:0,scale:0,age:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.instanceStride=e},spawn:function(t){var i=this.id,e=this.instanceData,s=this.instanceStride;return this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scale=t.scale,this.alpha=t.alpha,e[i*s+0]=1,e[i*s+1]=this.x,e[i*s+2]=this.y,e[i*s+3]=this.rotation,e[i*s+4]=this.scale,e[i*s+5]=0,e[i*s+6]=0,e[i*s+7]=this.alpha,this.age=0,this},update:function(t){var i=this.id,e=this.instanceData,s=this.instanceStride;(this.x<-100||740<this.x||this.y<-100||1060<this.y)&&this.remove(),e[i*s+1]=this.x,e[i*s+2]=this.y,e[i*s+3]=this.rotation,e[i*s+4]=this.scale,e[i*s+7]=this.alpha,this.age+=1}})}),phina.namespace(function(){phina.define("glb.EffectSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:1e3,init:function(t,i,e,s){this.superInit(t,i),this.setProgram(phigl.Program(t).attach("effectSprites.vs").attach("effectSprites.fs").link()).setIndexValues([0,1,2,1,3,2]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceAlpha").setUniforms("vMatrix","pMatrix","texture","globalScale");var a=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[e/2,s/2,1e3],[e/2,s/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-e/2,e/2,s/2,-s/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,this._createTexture())),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,0,1,0,0,0);this.setInstanceAttributeData(n);var h=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Effect(t,n,a).on("removed",function(){h.pool.push(this),n[this.id*a+0]=0})})},_createTexture:function(){var t=phina.graphics.Canvas().setSize(512,512),i=t.context,e=i.createRadialGradient(32,32,0,32,32,32);return e.addColorStop(0,"rgba(255, 255, 255, 0.3)"),e.addColorStop(.6,"rgba(255, 125,   0, 0.3)"),e.addColorStop(1,"rgba(255,   0,   0, 0.0)"),i.fillStyle=e,i.fillRect(0,0,64,64),t},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,domElement:null,gl:null,terrain:null,effectSprites:null,bulletSprites:null,init:function(t){t=t||{},this.superInit(t),this.originX=0,this.originY=0,this.domElement=document.createElement("canvas"),this.domElement.width=this.width,this.domElement.height=this.height,this.gl=this.domElement.getContext("webgl");var i=phigl.Extensions.getInstancedArrays(this.gl),e=(phigl.Extensions.getVertexArrayObject(this.gl),this.gl);e.clearColor(0,0,0,0),this.terrain=glb.Terrain(e,i,this.width,this.height),this.effectSprites=glb.EffectSprites(e,i,this.width,this.height),this.bulletSprites=glb.BulletSprites(e,i,this.width,this.height);var s=this,a=1.8;Array.range(-5,5).forEach(function(t){Array.range(-10,10).forEach(function(i){var e=s.getHex();e&&e.spawn({x:t*a+i%2,y:Math.randfloat(-1.2,1.2),z:i*a*1/Math.sqrt(3)*1.5,rotX:0,rotY:0,rotZ:0,scaleX:1,scaleY:1,scaleZ:1}).addChildTo(s)})})},getHex:function(){return this.terrain.pool.shift()},getEffect:function(){return this.effectSprites.pool.shift()},getBullet:function(){return this.bulletSprites.pool.shift()},update:function(t){this.terrain.update(t),this.effectSprites.update(t),this.bulletSprites.update(t)},draw:function(t){var i=this.gl;i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.terrain.render(),this.effectSprites.render(),this.bulletSprites.render(),i.flush();var e=this.domElement;t.context.drawImage(e,0,0,e.width,e.height,-this.width*this.originX,-this.height*this.originY,this.width,this.height)}})}),phina.namespace(function(){phina.define("glb.Hex",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,z:0,rotX:0,rotY:0,rotZ:0,scaleX:0,scaleY:0,scaleZ:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.instanceStride=e},spawn:function(t){var i=this.id,e=this.instanceData,s=this.instanceStride;return this.age=0,this.x=t.x,this.y=t.y,this.z=t.z,this.rotX=t.rotX,this.rotY=t.rotY,this.rotZ=t.rotZ,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.scaleZ=t.scaleZ,e[i*s+0]=1,e[i*s+1]=this.x,e[i*s+2]=this.y,e[i*s+3]=this.z,e[i*s+4]=this.rotX,e[i*s+5]=this.rotY,e[i*s+6]=this.rotZ,e[i*s+7]=this.scaleX,e[i*s+8]=this.scaleY,e[i*s+9]=this.scaleZ,this},update:function(t){var i=this.id,e=this.instanceData,s=this.instanceStride;this.z+=.1,18/Math.sqrt(3)*1.5<this.z&&(this.z-=18/Math.sqrt(3)*1.5*2),e[i*s+1]=this.x,e[i*s+2]=this.y,e[i*s+3]=this.z,e[i*s+4]=this.rotX,e[i*s+5]=this.rotY,e[i*s+6]=this.rotZ,e[i*s+7]=this.scaleX,e[i*s+8]=this.scaleY,e[i*s+9]=this.scaleZ,this.age+=1}})}),phina.namespace(function(){phina.define("glb.ObjAsset",{superClass:"phina.asset.File",init:function(){this.superInit()},getIndices:function(t,i){t=t||"defaultObject",i=i||"defaultGroup";var e=globj.ObjParser.parse(this.data)[t].groups[i],s=0;return e.faces.forEach(function(t){for(var i=1;i<t.length-1;i++)s+=3}),Array.range(s)},getAttributeData:function(t,i){t=t||"defaultObject",i=i||"defaultGroup";var e=globj.ObjParser.parse(this.data)[t].groups[i],s=[];return e.faces.forEach(function(t){for(var i=1;i<t.length-1;i++)s.push(t[0]),s.push(t[i+0]),s.push(t[i+1])}),s.map(function(t,i){var s=e.positions[t.position-1],a=e.texCoords[t.texCoord-1],n=e.normals[t.normal-1];return[s.x,s.y,s.z,a.u,a.v,n.x,n.y,n.z]}).flatten()}}),phina.asset.AssetLoader.assetLoadFunctions.obj=function(t,i){var e=glb.ObjAsset();return e.load({path:i})}}),phina.namespace(function(){phina.define("glb.Shape",{positions:null,normals:null,uvs:null,indices:null,init:function(){this.positions=[],this.normals=[],this.uvs=[],this.indices=[]},getDate:function(t){t=Array.prototype.concat([],arguments)}})}),phina.namespace(function(){phina.define("glb.Terrain",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:200,init:function(t,i,e,s){this.superInit(t,i);var a=phina.asset.AssetManager.get("obj","test.obj");this.setProgram(phigl.Program(t).attach("terrain.vs").attach("terrain.fs").link()).setIndexValues(a.getIndices("Cylinder")).setAttributes("position","uv","normal").setAttributeData(a.getAttributeData("Cylinder")).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor");for(var n=this.instanceStride/4,r=this.instanceData=[],h=0;h<this._count;h++)r.push(0,0,0,0,0,0,0,1,1,1);this.setInstanceAttributeData(r),this.uniforms.lightDirection.value=[1,1,1],this.uniforms.diffuseColor.value=[.44,.22,.22,1],this.uniforms.ambientColor.value=[.02,.02,.02,1];var o=mat4.lookAt(mat4.create(),[0,20,5],[0,0,0],[0,1,0]),l=mat4.perspective(mat4.create(),45,e/s,.1,1e4);this.uniforms.vpMatrix.value=mat4.mul(mat4.create(),l,o);var u=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Hex(t,r,n).on("removed",function(){u.pool.push(this),r[this.id*n+0]=0})})},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.draw(this._count)}})});