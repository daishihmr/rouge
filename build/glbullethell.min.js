phina.namespace(function(){phina.define("glb.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.instanceStride=e},spawn:function(t,i){var e=this.id,n=this.instanceData,s=this.instanceStride;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,n[e*s+0]=this.x,n[e*s+1]=this.y,n[e*s+2]=t.direction,n[e*s+3]=1.5,n[e*s+4]=i.type%8,n[e*s+5]=~~(i.type/8),n[e*s+6]=1,n[e*s+7]=1,n[e*s+8]=.2+~~(i.type/8)%2,n[e*s+9]=.2,n[e*s+10]=.2+~~(i.type/8)%2+1;var a=this;return t.onVanish=function(){a.remove()},this},update:function(t){var i=this.id,e=this.instanceData,n=this.instanceStride,s=this.runner;s.update(),this.x=s.x,this.y=s.y,(this.x<-100||740<this.x||this.y<-100||1060<this.y)&&this.remove(),e[i*n+0]=this.x,e[i*n+1]=this.y,e[i*n+7]=1.5+.6*Math.sin(.2*this.age),this.age+=1}})}),phina.namespace(function(){phina.define("glb.BulletSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:5e4,init:function(t,i,e,n){this.superInit(t,i),this.setProgram(phigl.Program(t).attach("bulletSprites.vs").attach("bulletSprites.fs").link()).setIndexValues([0,1,2,1,3,2]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[e/2,n/2,1e3],[e/2,n/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-e/2,e/2,n/2,-n/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,"bullets.png")),this.uniforms.globalScale.setValue(1);for(var a=this.instanceData=[],h=0;h<this._count;h++)a.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(a);var r=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Bullet(t,a,s).on("removed",function(){r.pool.push(this),a[this.id*s+6]=0})}),console.log(this)},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.Effect",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,age:0,init:function(t,i,e){this.superInit(),this.id=t,this.instanceData=i,this.instanceStride=e},spawn:function(t){this.id,this.instanceData,this.instanceStride;return this},update:function(t){this.id,this.instanceData,this.instanceStride;this.age+=1}})}),phina.namespace(function(){phina.define("glb.EffectSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:5e4,init:function(t,i,e,n){this.superInit(t,i),this.setProgram(phigl.Program(t).attach("effectSprites.vs").attach("effectSprites.fs").link()).setIndexValues([0,1,2,1,3,2]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[e/2,n/2,1e3],[e/2,n/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-e/2,e/2,n/2,-n/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,"bullets.png")),this.uniforms.globalScale.setValue(1);for(var a=this.instanceData=[],h=0;h<this._count;h++)a.push(0,0,0,1,0,0,0);this.setInstanceAttributeData(a);var r=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Effect(t,a,s).on("removed",function(){r.pool.push(this),a[this.id*s+6]=0})}),console.log(this)},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE),t.disable(t.DEPTH_TEST),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,domElement:null,gl:null,bulletSprites:null,init:function(t){t=t||{},this.superInit(t),this.originX=0,this.originY=0,this.domElement=document.createElement("canvas"),this.domElement.width=this.width,this.domElement.height=this.height,this.gl=this.domElement.getContext("webgl");var i=phigl.Extensions.getInstancedArrays(this.gl),e=(phigl.Extensions.getVertexArrayObject(this.gl),this.gl);e.clearColor(0,0,0,0),this.bulletSprites=glb.BulletSprites(e,i,this.width,this.height)},getEffect:function(){},getBullet:function(){return this.bulletSprites.pool.shift()},update:function(t){this.bulletSprites.update(t)},draw:function(t){var i=this.gl;i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.bulletSprites.render(),i.flush();var e=this.domElement;t.context.drawImage(e,0,0,e.width,e.height,-this.width*this.originX,-this.height*this.originY,this.width,this.height)}})}),phina.namespace(function(){phina.define("glb.Shape",{positions:null,normals:null,uvs:null,indices:null,init:function(){this.positions=[],this.normals=[],this.uvs=[],this.indices=[]},getDate:function(t){t=Array.prototype.concat([],arguments)}})});