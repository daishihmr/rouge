phina.namespace(function(){phina.define("glb.Bullet",{superClass:"phina.app.Element",id:-1,instanceData:null,runner:null,x:0,y:0,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t,e){var i=this.instanceData,a=this.index;this.runner=t,this.x=t.x,this.y=t.y,this.age=0,i[a+0]=this.x,i[a+1]=this.y,i[a+2]=t.direction,i[a+3]=1.5,i[a+4]=e.type%8,i[a+5]=~~(e.type/8),i[a+6]=1,i[a+7]=1,i[a+8]=.2+~~(e.type/8)%2,i[a+9]=.2,i[a+10]=.2+~~(e.type/8)%2+1;var s=this;return t.onVanish=function(){s.remove()},this},onremoved:function(){this.instanceData[this.index+6]=0},update:function(t){var e=this.instanceData,i=this.index,a=this.runner;return a.update(),this.x=a.x,this.y=a.y,this.x<-100||SCREEN_WIDTH+100<this.x||this.y<-100||SCREEN_HEIGHT+100<this.y?void this.remove():(e[i+0]=this.x,e[i+1]=this.y,e[i+7]=1.5+.6*Math.sin(.2*this.age),void(this.age+=1))}})}),phina.namespace(function(){phina.define("glb.BulletSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:1e3,init:function(t,e,i,a){this.superInit(t,e),this.setProgram(phina.asset.AssetManager.get("shader","bulletSprites")).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instancePosition","instanceRotation","instanceScale","instanceFrame","instanceVisible","instanceBrightness","instanceAuraColor").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[i/2,.5*a,1.5*i],[i/2,a/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-i/2,i/2,a/2,-a/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,"bullets.png")),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,1,0,0,0,0,0,0,0);this.setInstanceAttributeData(n);var o=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Bullet(t,n,s).on("removed",function(){o.pool.push(this)})})},get:function(){var t=this.pool.shift();return t},update:function(t){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.DownloadScene",{superClass:"phina.game.LoadingScene",init:function(t){this.superInit(t)}})}),phina.namespace(function(){phina.define("glb.Effect",{superClass:"phina.app.Element",id:-1,instanceData:null,x:0,y:0,rotation:0,scale:0,age:0,init:function(t,e,i){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i},spawn:function(t){var e=this.index,i=this.instanceData;return this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scale=t.scale,this.alpha=t.alpha,i[e+0]=1,i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scale,i[e+5]=0,i[e+6]=0,i[e+7]=this.alpha,this.age=0,this},update:function(t){var e=this.index,i=this.instanceData;return this.x<-100||740<this.x||this.y<-100||1060<this.y?void this.remove():(i[e+1]=this.x,i[e+2]=this.y,i[e+3]=this.rotation,i[e+4]=this.scale,i[e+7]=this.alpha,void(this.age+=1))},onremoved:function(){this.instanceData[this.index+0]=0}})}),phina.namespace(function(){phina.define("glb.EffectSprites",{superClass:"phigl.InstancedDrawable",instanceData:null,pool:null,_count:200,init:function(t,e,i,a){this.superInit(t,e),this.setProgram(phina.asset.AssetManager.get("shader","effectSprites")).setDrawMode(t.TRIANGLE_STRIP).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeDataArray([{unitSize:2,data:[-16,16,16,16,-16,-16,16,-16]},{unitSize:2,data:[0,.125,.125,.125,0,0,.125,0]}]).setInstanceAttributes("instanceVisible","instancePosition","instanceRotation","instanceScale","instanceFrame","instanceAlpha").setUniforms("vMatrix","pMatrix","texture","globalScale");var s=this.instanceStride/4;this.uniforms.vMatrix.setValue(mat4.lookAt(mat4.create(),[i/2,.5*a,1.5*i],[i/2,a/2,0],[0,1,0])),this.uniforms.pMatrix.setValue(mat4.ortho(mat4.create(),-i/2,i/2,a/2,-a/2,.1,3e3)),this.uniforms.texture.setValue(0).setTexture(phigl.Texture(t,this._createTexture())),this.uniforms.globalScale.setValue(1);for(var n=this.instanceData=[],r=0;r<this._count;r++)n.push(0,0,0,0,1,0,0,0);this.setInstanceAttributeData(n);var o=this;this.pool=Array.range(0,this._count).map(function(t){return glb.Effect(t,n,s).on("removed",function(){o.pool.push(this)})})},_createTexture:function(){var t=phina.graphics.Canvas().setSize(512,512),e=t.context,i=e.createRadialGradient(32,32,0,32,32,32);return i.addColorStop(0,"rgba(255, 255, 255, 0.3)"),i.addColorStop(.6,"rgba(255, 125,   0, 0.3)"),i.addColorStop(1,"rgba(255,   0,   0, 0.0)"),e.fillStyle=i,e.fillRect(0,0,64,64),t},get:function(){return this.pool.shift()},update:function(){this.setInstanceAttributeData(this.instanceData)},render:function(){var t=this.gl;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE),t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),this.uniforms.globalScale.value=1,this.draw(this._count)}})}),phina.namespace(function(){phina.define("glb.GLLayer",{superClass:"phina.display.Layer",renderChildBySelf:!0,ready:!1,domElement:null,gl:null,terrain:null,itemDrawer:null,effectSprites:null,bulletSprites:null,playerDrawer:null,enemyDrawer:null,glowEffect:null,framebufferNormal:null,framebufferBlur:null,ppZoomBlur:null,ppCopy:null,zoomCenterX:0,zoomCenterY:0,zoomStrength:0,zoomAlpha:0,init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),this.originX=0,this.originY=0,this.domElement=document.createElement("canvas"),this.domElement.width=this.width*glb.GLLayer.quality,this.domElement.height=this.height*glb.GLLayer.quality,this.gl=this.domElement.getContext("webgl"),this.gl.clearColor(0,0,0,0),this.gl.clearDepth(1)},start:function(){var t=this.gl,e=phigl.Extensions.getInstancedArrays(t),i=(phigl.Extensions.getVertexArrayObject(t),this.domElement.width),a=this.domElement.height,s=this.width,n=this.height,r=Math.pow(2,~~Math.log2(i)+1),o=Math.pow(2,~~Math.log2(a)+1);glb.GLLayer.quality;this.terrain=glb.Terrain(t,e,s,n),this.itemDrawer=glb.ObjDrawer(t,e,s,n),this.effectSprites=glb.EffectSprites(t,e,s,n),this.enemyDrawer=glb.ObjDrawer(t,e,s,n),this.playerDrawer=glb.ObjDrawer(t,e,s,n),this.bulletSprites=glb.BulletSprites(t,e,s,n),this.glowEffect=glb.GlowEffect(t,i,a),this.framebufferNormal=phigl.Framebuffer(t,r,o),this.framebufferBlur=phigl.Framebuffer(t,r,o),this.ppZoomBlur=glb.PostProcessing(t,i,a,"effect_zoom",["canvasSize","center","strength"]),this.ppCopy=glb.PostProcessing(t,i,a,"effect_copy",["alpha"]),this.setupTerrain()},setupTerrain:function(){var t=this,e=glb.Terrain.countX,i=glb.Terrain.countZ,a=glb.Terrain.unit;Array.range(-e,e).forEach(function(e){Array.range(-i,i).forEach(function(i){var s=t.terrain.get();s&&(s.spawn({x:e*a+i%2,y:0,z:i*a*1/Math.sqrt(3)*1.5,rotX:(-90).toRadian(),rotY:90..toRadian(),rotZ:0,scaleX:1.2,scaleY:1.2,scaleZ:1.2}).addChildTo(t),Math.random()<.03&&s.on("enterframe",function(t){this.y=2.5*(1+Math.sin(.01*t.app.ticker.frame))}))})}),this.ready=!0},update:function(t){this.ready&&(this.terrain.update(t),this.itemDrawer.update(t),this.effectSprites.update(t),this.enemyDrawer.update(t),this.playerDrawer.update(t),this.bulletSprites.update(t),t.ticker.frame%100===0&&this.startZoom(Math.random()*SCREEN_WIDTH,Math.random()*SCREEN_HEIGHT))},draw:function(t){if(this.ready){var e=this.gl,i=this.domElement,a=i.width,s=i.height;this.glowEffect.bindCurrent(),e.viewport(0,0,a,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.playerDrawer.renderGlow(),this.enemyDrawer.renderGlow(),this.glowEffect.renderBefore(),e.flush(),this.framebufferNormal.bind(),e.viewport(0,0,a,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.terrain.render(),this.itemDrawer.render(),this.effectSprites.render(),this.enemyDrawer.render(),this.playerDrawer.render(),this.glowEffect.renderCurrent(),this.bulletSprites.render(),e.flush(),this.framebufferBlur.bind(),e.viewport(0,0,a,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.ppZoomBlur.render(this.framebufferNormal.texture,{center:this.ppZoomBlur.viewCoordToShaderCoord(this.zoomCenterX,this.zoomCenterY),strength:this.zoomStrength}),e.flush(),phigl.Framebuffer.unbind(e),e.viewport(0,0,a,s),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this.ppCopy.render(this.framebufferNormal.texture,{alpha:1-this.zoomAlpha}),this.ppCopy.render(this.framebufferBlur.texture,{alpha:this.zoomAlpha}),e.flush(),t.context.drawImage(i,0,0,a,s,-this.width*this.originX,-this.height*this.originY,this.width,this.height),this.glowEffect.switchFramebuffer()}},startZoom:function(t,e){this.zoomCenterX=t,this.zoomCenterY=e,this.tweener.clear().set({zoomStrength:0,zoomAlpha:1}).to({zoomStrength:30,zoomAlpha:0},40,"easeOutQuad")},_static:{quality:1}})}),phina.namespace(function(){phina.define("glb.GlowEffect",{gl:null,current:null,before:null,drawer:null,width:0,height:0,init:function(t,e,i){this.gl=t;var a=Math.pow(2,~~Math.log2(e)+1),s=Math.pow(2,~~Math.log2(i)+1);this.current=phigl.Framebuffer(t,a,s),this.before=phigl.Framebuffer(t,a,s),this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader","effect_blur")).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/s,1,1,e/a,i/s,-1,-1,0,0,1,-1,e/a,0]).setUniforms("texture","alpha","canvasSize"),this.copyDrawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader","effect_copy")).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/s,1,1,e/a,i/s,-1,-1,0,0,1,-1,e/a,0]).setUniforms("texture","alpha"),this.width=e,this.height=i},bindCurrent:function(){this.current.bind()},renderCurrent:function(){var t=this.gl;return t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE),this.drawer.uniforms.texture.setValue(0).setTexture(this.current.texture),this.drawer.uniforms.alpha.value=.2,this.drawer.uniforms.canvasSize.value=this.current.width,this.drawer.draw(),this},renderBefore:function(){var t=this.gl;return t.enable(t.BLEND),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.copyDrawer.uniforms.texture.setValue(0).setTexture(this.before.texture),this.copyDrawer.uniforms.alpha.value=.99,this.copyDrawer.draw(),this},switchFramebuffer:function(){var t=this.current;this.current=this.before,this.before=t}})}),phina.namespace(function(){phina.define("glb.LoadScene",{superClass:"phina.display.DisplayScene",init:function(t){this.superInit(),this.gl=t,this.totalCount=0,this.count=0,this.one("enter",function(){this.load()})},onprogress:function(){this.count+=1,console.log(this.count+"/"+this.totalCount)},oncomplete:function(){this.app.popScene()},load:function(){var t=this,e=this.gl,i=phina.asset.AssetManager;this.totalCount=Object.keys(i.assets.vertexShader).length+Object.keys(i.assets.obj).length+Object.keys(i.assets.image).length;var a=[];return i.assets.vertexShader.forIn(function(s,n){var r=phina.util.Flow(function(a){var n=s.replace(".vs",""),r=phigl.Program(e).attach(n+".vs").attach(n+".fs").link();i.set("shader",n,r),t.flare("progress"),a()});a.push(r)}),i.assets.obj.forIn(function(s,n){var r=phina.util.Flow(function(a){var r=n.getAttributeData(),o=n.getAttributeDataEdges(),h=phigl.Vbo(e).set(r),u=phigl.Ibo(e).set(Array.range(r.length/8)),l=phigl.Vbo(e).set(o),c=phigl.Ibo(e).set(Array.range(o.length/3));i.set("vbo",s,h),i.set("ibo",s,u),i.set("edgesVbo",s,l),i.set("edgesIbo",s,c),t.flare("progress"),a()});a.push(r)}),i.assets.image.forIn(function(s,n){var r=phina.util.Flow(function(a){var r=phigl.Texture(e,n);i.set("texture",s,r),t.flare("progress"),a()});a.push(r)}),phina.util.Flow.all(a).then(function(){t.flare("complete")}),this},deleteAll:function(){var t=phina.asset.AssetManager;return t.assets.vbo.forIn(function(t,e){e["delete"]()}),t.assets.ibo.forIn(function(t,e){e["delete"]()}),t.assets.texture.forIn(function(t,e){e["delete"]()}),t.assets.vbo={},t.assets.ibo={},t.assets.texture={},this}})}),phina.namespace(function(){phina.define("glb.Obj",{superClass:"phina.app.Element",id:-1,instanceData:null,position:null,quaternion:null,scale:null,matrix:null,dirty:!0,init:function(t,e,i,a){this.superInit(),this.id=t,this.instanceData=e,this.index=t*i,this.objType=a,this.position=vec3.create(),this.quaternion=quat.create(),this.scale=vec3.create(),this.matrix=mat4.create()},spawn:function(t){var e=this.index,i=this.instanceData;return this.age=0,this.x=t.x,this.y=t.y,this.z=t.z,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.scaleZ=t.scaleZ,quat.identity(this.quaternion),quat.rotateZ(this.quaternion,this.quaternion,t.rotZ),quat.rotateY(this.quaternion,this.quaternion,t.rotY),quat.rotateX(this.quaternion,this.quaternion,t.rotX),i[e+0]=1,this.dirty=!0,this.update(),this},update:function(t){var e=this.index,i=this.instanceData;this.dirty&&(mat4.fromRotationTranslationScale(this.matrix,this.quaternion,this.position,this.scale),i[e+1]=this.matrix[0],i[e+2]=this.matrix[1],i[e+3]=this.matrix[2],i[e+4]=this.matrix[4],i[e+5]=this.matrix[5],i[e+6]=this.matrix[6],i[e+7]=this.matrix[8],i[e+8]=this.matrix[9],i[e+9]=this.matrix[10],i[e+10]=this.matrix[12],i[e+11]=this.matrix[13],i[e+12]=this.matrix[14],this.dirty=!1),this.age+=1},onremoved:function(){this.instanceData[this.index+0]=0},rotateX:function(t){return quat.rotateX(this.quaternion,this.quaternion,t),this.dirty=!0,this},rotateY:function(t){return quat.rotateY(this.quaternion,this.quaternion,t),this.dirty=!0,this},rotateZ:function(t){return quat.rotateZ(this.quaternion,this.quaternion,t),this.dirty=!0,this},lookAt:function(t){var e=this.position,i=t.position;quat.identity(this.quaternion),this.rotateZ(Math.atan2(i[1]-e[1],i[0]-e[0]));var a=vec3.sub(vec3.create(),[i[0],i[1],0],[e[0],e[1],0]),s=vec3.sub(vec3.create(),i,e),n=quat.rotationTo(quat.create(),vec3.normalize(a,a),vec3.normalize(s,s));return quat.mul(this.quaternion,this.quaternion,n),this.dirty=!0,this},_accessor:{x:{get:function(){return this.position[0]},set:function(t){this.position[0]=t,this.dirty=!0}},y:{get:function(){return this.position[1]},set:function(t){this.position[1]=t,this.dirty=!0}},z:{get:function(){return this.position[2]},set:function(t){this.position[2]=t,this.dirty=!0}},scaleX:{get:function(){return this.scale[0]},set:function(t){this.scale[0]=t,this.dirty=!0}},scaleY:{get:function(){return this.scale[1]},set:function(t){this.scale[1]=t,this.dirty=!0}},scaleZ:{get:function(){return this.scale[2]},set:function(t){this.scale[2]=t,this.dirty=!0}}}})}),phina.namespace(function(){phina.define("glb.ObjAsset",{superClass:"phina.asset.File",init:function(){this.superInit()},getAttributeData:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e],a=[];return i.faces.forEach(function(t){for(var e=1;e<t.length-1;e++)a.push(t[0]),a.push(t[e+0]),a.push(t[e+1])}),a.map(function(t,e){var a=i.positions[t.position-1],s=i.texCoords[t.texCoord-1],n=i.normals[t.normal-1];return[a.x,a.y,a.z,s.u,1-s.v,n.x,n.y,n.z]}).flatten()},getAttributeDataEdges:function(t,e){t=t||"defaultObject",e=e||"defaultGroup";var i=globj.ObjParser.parse(this.data)[t].groups[e];return i.faces.map(function(t){for(var e=[],i=0;i<t.length-1;i++)e.push([t[i+0].position,t[i+1].position]);return e.push([t.last.position,t.first.position]),e}).flatten(1).uniq(function(t,e){return t[0]===e[0]&&t[1]===e[1]}).map(function(t){var e=i.positions[t[0]-1],a=i.positions[t[1]-1];return[[e.x,e.y,e.z],[a.x,a.y,a.z]]}).flatten()}}),phina.asset.AssetLoader.assetLoadFunctions.obj=function(t,e){var i=glb.ObjAsset();return i.load({path:e})}}),phina.namespace(function(){phina.define("glb.ObjDrawer",{gl:null,objTypes:null,counts:null,instanceData:null,ibos:null,vbos:null,textures:null,pools:null,faceDrawer:null,cameraPosition:null,init:function(t,e,i,a){this.gl=t,this.objTypes=[],this.counts={},this.instanceData={},this.ibos={},this.vbos={},this.textures={},this.pools={},this.faceDrawer=phigl.InstancedDrawable(t,e).setProgram(phina.asset.AssetManager.get("shader","obj")).setAttributes("position","uv","normal").setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition","texture"),this.glowDrawer=phigl.InstancedDrawable(t,e).setProgram(phina.asset.AssetManager.get("shader","objGlow")).setAttributes("position","uv","normal").setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3").setUniforms("vpMatrix","texture"),this.cameraPosition=vec3.set(vec3.create(),i/2,.5*a,1.5*i),this.vMatrix=mat4.lookAt(mat4.create(),this.cameraPosition,[i/2,a/2,0],[0,1,0]),this.pMatrix=mat4.ortho(mat4.create(),-i/2,i/2,a/2,-a/2,.1,3e3),this.vpMatrix=mat4.create(),this.lightDirection=vec3.set(vec3.create(),-1,0,-1),this.diffuseColor=[.9,.9,.9,1],this.ambientColor=[.4,.4,.4,1]},addObjType:function(t,e){e=e||1;var i=this,a=this.faceDrawer.instanceStride/4;if(!this.objTypes.contains(t)){this.counts[t]=e;var s=this.instanceData[t]=Array.range(e).map(function(t){return[0,1,0,0,0,1,0,0,0,1,0,0,0]}).flatten();this.ibos[t]=phina.asset.AssetManager.get("ibo",t+".obj"),this.vbos[t]=phina.asset.AssetManager.get("vbo",t+".obj"),this.textures[t]=phina.asset.AssetManager.get("texture",t+".png"),this.pools[t]=Array.range(e).map(function(e){return glb.Obj(e,s,a,t).on("removed",function(){i.pools[this.objType].push(this)})}),this.objTypes.push(t)}},get:function(t){return this.pools[t].shift()},update:function(t){mat4.mul(this.vpMatrix,this.pMatrix,this.vMatrix),vec3.normalize(this.lightDirection,this.lightDirection)},render:function(){var t=this,e=this.gl;e.enable(e.BLEND),e.enable(e.DEPTH_TEST),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.faceDrawer.uniforms.vpMatrix.value=this.vpMatrix,this.faceDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.faceDrawer.uniforms.lightDirection.value=this.lightDirection,this.faceDrawer.uniforms.diffuseColor.value=this.diffuseColor,this.faceDrawer.uniforms.ambientColor.value=this.ambientColor,this.objTypes.forEach(function(e){var i=t.counts[e],a=t.instanceData[e],s=t.ibos[e],n=t.vbos[e],r=t.textures[e];t.faceDrawer.setIndexBuffer(s).setAttributeVbo(n).setInstanceAttributeData(a),t.faceDrawer.uniforms.texture.setValue(0).setTexture(r),t.faceDrawer.draw(i)})},renderGlow:function(){var t=this,e=this.gl;e.enable(e.BLEND),e.enable(e.DEPTH_TEST),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.glowDrawer.uniforms.vpMatrix.value=this.vpMatrix,this.objTypes.forEach(function(e){var i=t.counts[e],a=t.instanceData[e],s=t.ibos[e],n=t.vbos[e],r=t.textures[e];t.glowDrawer.setIndexBuffer(s).setAttributeVbo(n).setInstanceAttributeData(a),t.glowDrawer.uniforms.texture.setValue(0).setTexture(r),t.glowDrawer.draw(i)})}})}),phina.namespace(function(){phina.define("glb.PostProcessing",{gl:null,drawer:null,width:0,height:0,init:function(t,e,i,a,s){this.gl=t;var n=Math.pow(2,~~Math.log2(e)+1),r=Math.pow(2,~~Math.log2(i)+1);this.drawer=phigl.Drawable(t).setDrawMode(t.TRIANGLE_STRIP).setProgram(phina.asset.AssetManager.get("shader",a)).setIndexValues([0,1,2,3]).setAttributes("position","uv").setAttributeData([-1,1,0,i/r,1,1,e/n,i/r,-1,-1,0,0,1,-1,e/n,0]).setUniforms(["texture","canvasSize"].concat(s)),this.width=e,this.height=i,this.sw=n,this.sh=r},render:function(t,e){var i=this.gl;return i.enable(i.BLEND),i.disable(i.DEPTH_TEST),i.blendFunc(i.SRC_ALPHA,i.ONE),this.drawer.uniforms.texture.setValue(0).setTexture(t),this.drawer.uniforms.canvasSize.value=[this.sw,this.sh],this.setUniforms(e),this.drawer.draw(),this},setUniforms:function(t){var e=this.drawer.uniforms;t.forIn(function(t,i){e[t].value=i})},viewCoordToShaderCoord:function(t,e){var i=glb.GLLayer.quality;return[t*i/this.sw,(SCREEN_HEIGHT-e*i)/this.sh]}})}),phina.namespace(function(){phina.define("glb.Terrain",{gl:null,faceDrawer:null,edgeDrawer:null,instanceData:null,pool:null,count:0,cameraPosition:null,init:function(t,e,i,a){this.gl=t,this.count=2*glb.Terrain.countX*(2*glb.Terrain.countZ),this.faceDrawer=phigl.InstancedDrawable(t,e),this.edgeDrawer=phigl.InstancedDrawable(t,e);for(var s=this.instanceData=[],n=0;n<this.count;n++)s.push(0,1,0,0,0,1,0,0,0,1,0,0,0);this.faceDrawer.setProgram(phina.asset.AssetManager.get("shader","terrain")).setIndexBuffer(phina.asset.AssetManager.get("ibo","hex.obj")).setAttributes("position","uv","normal").setAttributeVbo(phina.asset.AssetManager.get("vbo","hex.obj")).setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3").setUniforms("vpMatrix","lightDirection","diffuseColor","ambientColor","cameraPosition"),this.edgeDrawer.setDrawMode(t.LINES).setProgram(phina.asset.AssetManager.get("shader","terrainEdge")).setIndexBuffer(phina.asset.AssetManager.get("edgesIbo","hex.obj")).setAttributes("position").setAttributeVbo(phina.asset.AssetManager.get("edgesVbo","hex.obj")).setInstanceAttributes("instanceVisible","instanceMatrix0","instanceMatrix1","instanceMatrix2","instanceMatrix3").setUniforms("vpMatrix","cameraPosition","color");var r=this.edgeDrawer.instanceStride/4;this.cameraPosition=vec3.create(),vec3.set(this.cameraPosition,6,20,20);var o=mat4.lookAt(mat4.create(),this.cameraPosition,[0,0,0],[0,1,0]),h=mat4.perspective(mat4.create(),45,i/a,.1,1e4);this.faceDrawer.uniforms.vpMatrix.value=mat4.mul(mat4.create(),h,o),this.faceDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.edgeDrawer.uniforms.vpMatrix.value=mat4.mul(mat4.create(),h,o),this.edgeDrawer.uniforms.cameraPosition.value=this.cameraPosition,this.lightDirection=vec3.set(vec3.create(),2,.5,0),this.faceDrawer.uniforms.lightDirection.value=vec3.normalize(vec3.create(),this.lightDirection),this.faceDrawer.uniforms.diffuseColor.value=[.22,.22,.22*1.6,.65],this.faceDrawer.uniforms.ambientColor.value=[.05,.05,.05,1],this.edgeDrawer.uniforms.color.value=[.5,.5,.6,1];var u=this;this.pool=Array.range(0,this.count).map(function(t){return glb.Obj(t,s,r).on("enterframe",function(){this.x+=.025*u.cameraPosition[0],this.z+=.025*u.cameraPosition[2];var t=glb.Terrain.countX,e=glb.Terrain.countZ,i=glb.Terrain.unit;this.x<-t*i?this.x+=t*i*2:t*i<this.x&&(this.x-=t*i*2),this.z<-e*i*1/Math.sqrt(3)*1.5?this.z+=e*i*1/Math.sqrt(3)*1.5*2:e*i*1/Math.sqrt(3)*1.5<this.z&&(this.z-=e*i*1/Math.sqrt(3)*1.5*2)}).on("removed",function(){u.pool.push(this)})}),this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData)},update:function(t){var e=.001*t.ticker.frame;this.lightDirection=vec3.set(this.lightDirection,1*Math.cos(5*e),.5,1*Math.sin(5*e)),vec3.normalize(this.lightDirection,this.lightDirection),this.faceDrawer.uniforms.lightDirection.value=this.lightDirection,this.faceDrawer.setInstanceAttributeData(this.instanceData),this.edgeDrawer.setInstanceAttributeData(this.instanceData)},get:function(){return this.pool.shift()},render:function(){var t=this.gl;t.enable(t.BLEND),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.cullFace(t.FRONT),this.edgeDrawer.draw(this.count),this.faceDrawer.draw(this.count)},_static:{countX:12,countZ:22,unit:2.05}})}),phina.namespace(function(){Array.prototype.$method("uniq",function(t){return t?this.filter(function(e,i,a){return!a.slice(0,i).some(function(i){return t(e,i)})}):this.filter(function(t,e,i){return i.indexOf(t)===e})})});